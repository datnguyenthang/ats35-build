webpackJsonp([13],{1799:function(n,l,e){"use strict";function t(n){return d._42(0,[(n()(),d._16(0,0,null,null,7,"ion-chip",[["class","addon-messages-date"],["color","light"]],null,null,null,null,null)),d._15(1,16384,null,0,z.a,[$.a,d.p,d.K],{color:[0,"color"]},null),(n()(),d._40(-1,null,["\n                    "])),(n()(),d._16(3,0,null,null,3,"ion-label",[],null,null,null,null,null)),d._15(4,16384,null,0,N.a,[$.a,d.p,d.K,[8,null],[8,null],[8,null],[8,null]],null,null),(n()(),d._40(5,null,["",""])),d._34(6,2),(n()(),d._40(-1,null,["\n                "]))],function(n,l){n(l,1,0,"light")},function(n,l){n(l,5,0,d._41(l,5,0,n(l,6,0,d._29(l.parent.parent,0),l.parent.context.$implicit.timecreated,"LL")))})}function s(n){return d._42(0,[(n()(),d._16(0,0,null,null,11,"ion-chip",[["class","addon-messages-unreadfrom"],["color","light"]],null,null,null,null,null)),d._15(1,16384,null,0,z.a,[$.a,d.p,d.K],{color:[0,"color"]},null),(n()(),d._40(-1,null,["\n                    "])),(n()(),d._16(3,0,null,null,4,"ion-label",[],null,null,null,null,null)),d._15(4,16384,null,0,N.a,[$.a,d.p,d.K,[8,null],[8,null],[8,null],[8,null]],null,null),(n()(),d._40(5,null,["",""])),d._33(6,{$a:0}),d._32(131072,H.a,[W.a,d.i]),(n()(),d._40(-1,null,["\n                    "])),(n()(),d._16(9,0,null,null,1,"ion-icon",[["name","arrow-round-down"],["role","img"]],[[2,"hide",null]],null,null,null,null)),d._15(10,147456,null,0,V.a,[$.a,d.p,d.K],{name:[0,"name"]},null),(n()(),d._40(-1,null,["\n                "]))],function(n,l){n(l,1,0,"light");n(l,10,0,"arrow-round-down")},function(n,l){var e=l.component;n(l,5,0,d._41(l,5,0,d._29(l,7).transform("addon.messages.newmessages",n(l,6,0,e.title))));n(l,9,0,d._29(l,10)._hidden)})}function a(n){return d._42(0,[(n()(),d._16(0,0,null,null,3,"ion-note",[],null,null,null,null,null)),d._15(1,16384,null,0,j.a,[$.a,d.p,d.K],null,null),(n()(),d._40(2,null,["\n                        ","\n                    "])),d._34(3,2)],null,function(n,l){n(l,2,0,d._41(l,2,0,n(l,3,0,d._29(l.parent.parent,0),l.parent.context.$implicit.timecreated,"dftimedate")))})}function o(n){return d._42(0,[(n()(),d._16(0,0,null,null,3,"ion-note",[],null,null,null,null,null)),d._15(1,16384,null,0,j.a,[$.a,d.p,d.K],null,null),(n()(),d._16(2,0,null,null,1,"ion-icon",[["name","time"],["role","img"]],[[2,"hide",null]],null,null,null,null)),d._15(3,147456,null,0,V.a,[$.a,d.p,d.K],{name:[0,"name"]},null)],function(n,l){n(l,3,0,"time")},function(n,l){n(l,2,0,d._29(l,3)._hidden)})}function i(n){return d._42(0,[(n()(),d._16(0,0,null,null,6,"button",[["class","addon-messages-delete-button"],["clear","true"],["icon-only",""],["ion-button",""]],[[24,"@coreSlideInOut",0],[1,"aria-label",0]],[[null,"click"]],function(n,l,e){var t=!0;if("click"===l){t=!1!==n.component.deleteMessage(n.parent.context.$implicit,n.parent.context.index)&&t}return t},G.b,G.a)),d._15(1,1097728,[[5,4]],0,q.a,[[8,""],$.a,d.p,d.K],{clear:[0,"clear"]},null),d._32(131072,H.a,[W.a,d.i]),(n()(),d._40(-1,0,["\n                        "])),(n()(),d._16(4,0,null,0,1,"ion-icon",[["color","danger"],["name","trash"],["role","img"]],[[2,"hide",null]],null,null,null,null)),d._15(5,147456,null,0,V.a,[$.a,d.p,d.K],{color:[0,"color"],name:[1,"name"]},null),(n()(),d._40(-1,0,["\n                    "]))],function(n,l){n(l,1,0,"true");n(l,5,0,"danger","trash")},function(n,l){n(l,0,0,"fromRight",d._41(l,0,1,d._29(l,2).transform("addon.messages.deletemessage")));n(l,4,0,d._29(l,5)._hidden)})}function u(n){return d._42(0,[(n()(),d._16(0,0,null,null,32,null,null,null,null,null,null,null)),(n()(),d._40(-1,null,["\n                "])),(n()(),d._11(16777216,null,null,1,null,t)),d._15(3,16384,null,0,Y.k,[d.W,d.T],{ngIf:[0,"ngIf"]},null),(n()(),d._40(-1,null,["\n\n                "])),(n()(),d._11(16777216,null,null,1,null,s)),d._15(6,16384,null,0,Y.k,[d.W,d.T],{ngIf:[0,"ngIf"]},null),(n()(),d._40(-1,null,["\n\n                "])),(n()(),d._16(8,0,null,null,23,"ion-item",[["class","addon-message item item-block"],["text-wrap",""]],[[2,"addon-message-mine",null],[24,"@coreSlideInOut",0]],[[null,"longPress"]],function(n,l,e){var t=!0;if("longPress"===l){t=!1!==n.component.copyMessage(n.context.$implicit.smallmessage)&&t}return t},J.b,J.a)),d._15(9,212992,null,0,Q.a,[d.p],null,{longPress:"longPress"}),d._15(10,1097728,null,3,Z.a,[nn.a,$.a,d.p,d.K,[2,ln.a]],null,null),d._37(335544320,4,{contentLabel:0}),d._37(603979776,5,{_buttons:1}),d._37(603979776,6,{_icons:1}),d._15(14,16384,null,0,en.a,[],null,null),(n()(),d._40(-1,2,["\n                    "])),(n()(),d._40(-1,2,["\n                    "])),(n()(),d._16(17,0,null,2,4,"p",[["class","addon-message-text"]],null,null,null,null,null)),(n()(),d._40(-1,null,["\n                        "])),(n()(),d._16(19,0,null,null,1,"core-format-text",[],null,[[null,"afterRender"]],function(n,l,e){var t=!0;if("afterRender"===l){t=!1!==(n.context.last&&n.component.scrollToBottom())&&t}return t},null,null)),d._15(20,540672,null,0,tn.a,[d.p,m.a,y.a,sn.a,W.a,an.a,v.a,on.a,b.a,un.a,M.a,rn.a,[2,cn.a],[2,dn.a]],{text:[0,"text"]},{afterRender:"afterRender"}),(n()(),d._40(-1,null,["\n                    "])),(n()(),d._40(-1,2,["\n                    "])),(n()(),d._11(16777216,null,2,1,null,a)),d._15(24,16384,null,0,Y.k,[d.W,d.T],{ngIf:[0,"ngIf"]},null),(n()(),d._40(-1,2,["\n                    "])),(n()(),d._11(16777216,null,2,1,null,o)),d._15(27,16384,null,0,Y.k,[d.W,d.T],{ngIf:[0,"ngIf"]},null),(n()(),d._40(-1,2,["\n\n                    "])),(n()(),d._11(16777216,null,2,1,null,i)),d._15(30,16384,null,0,Y.k,[d.W,d.T],{ngIf:[0,"ngIf"]},null),(n()(),d._40(-1,2,["\n                "])),(n()(),d._40(-1,null,["\n            "]))],function(n,l){var e=l.component;n(l,3,0,e.showDate(l.context.$implicit,e.messages[l.context.index-1]));n(l,6,0,l.context.$implicit.unreadFrom),n(l,9,0);n(l,20,0,l.context.$implicit.text);n(l,24,0,!l.context.$implicit.pending);n(l,27,0,l.context.$implicit.pending);n(l,30,0,!l.context.$implicit.sending&&e.showDelete)},function(n,l){var e=l.component;n(l,8,0,l.context.$implicit.useridfrom==e.currentUserId,l.context.$implicit.useridfrom==e.currentUserId?"":"fromLeft")})}function r(n){return d._42(0,[(n()(),d._16(0,0,null,null,2,"core-empty-box",[["icon","chatbubbles"]],null,null,null,gn.b,gn.a)),d._15(1,49152,null,0,fn.a,[],{message:[0,"message"],icon:[1,"icon"]},null),d._32(131072,H.a,[W.a,d.i])],function(n,l){n(l,1,0,d._41(l,1,0,d._29(l,2).transform("addon.messages.nomessages")),"chatbubbles")},null)}function c(n){return d._42(0,[d._32(0,mn.a,[b.a,W.a]),d._37(402653184,1,{content:0}),(n()(),d._16(2,0,null,null,35,"ion-header",[],null,null,null,null,null)),d._15(3,16384,null,0,_n.a,[$.a,d.p,d.K,[2,hn.a]],null,null),(n()(),d._40(-1,null,["\n    "])),(n()(),d._16(5,0,null,null,11,"ion-navbar",[["class","toolbar"]],[[8,"hidden",0],[2,"statusbar-padding",null]],null,null,pn.b,pn.a)),d._15(6,49152,null,0,yn.a,[vn.a,[2,hn.a],[2,cn.a],$.a,d.p,d.K],null,null),(n()(),d._40(-1,3,["\n        "])),(n()(),d._16(8,0,null,3,3,"ion-title",[],null,null,null,bn.b,bn.a)),d._15(9,49152,null,0,Mn.a,[$.a,d.p,d.K,[2,wn.a],[2,yn.a]],null,null),(n()(),d._16(10,0,null,0,1,"core-format-text",[],null,null,null,null,null)),d._15(11,540672,null,0,tn.a,[d.p,m.a,y.a,sn.a,W.a,an.a,v.a,on.a,b.a,un.a,M.a,rn.a,[2,cn.a],[2,dn.a]],{text:[0,"text"]},null),(n()(),d._40(-1,3,["\n        "])),(n()(),d._16(13,0,null,2,2,"ion-buttons",[["end",""]],null,null,null,null,null)),d._15(14,16384,null,1,In.a,[$.a,d.p,d.K,[2,wn.a],[2,yn.a]],null,null),d._37(603979776,2,{_buttons:1}),(n()(),d._40(-1,3,["\n    "])),(n()(),d._40(-1,null,["\n    "])),(n()(),d._16(18,0,null,null,18,"core-navbar-buttons",[["end",""]],null,null,null,Pn.b,Pn.a)),d._15(19,245760,null,1,Dn.a,[d.p,b.a,y.a],null,null),d._37(603979776,3,{buttons:1}),(n()(),d._40(-1,0,["\n        "])),(n()(),d._16(22,0,null,0,5,"button",[["clear","true"],["icon-only",""],["ion-button",""]],[[8,"hidden",0]],[[null,"click"]],function(n,l,e){var t=!0;if("click"===l){t=!1!==n.component.toggleDelete()&&t}return t},G.b,G.a)),d._15(23,1097728,[[3,4]],0,q.a,[[8,""],$.a,d.p,d.K],{clear:[0,"clear"]},null),(n()(),d._40(-1,0,["\n            "])),(n()(),d._16(25,0,null,0,1,"ion-icon",[["name","trash"],["role","img"]],[[2,"hide",null]],null,null,null,null)),d._15(26,147456,null,0,V.a,[$.a,d.p,d.K],{name:[0,"name"]},null),(n()(),d._40(-1,0,["\n        "])),(n()(),d._40(-1,0,["\n        "])),(n()(),d._16(29,0,null,0,6,"a",[["core-user-link",""]],[[8,"hidden",0],[1,"aria-label",0]],null,null,null,null)),d._15(30,81920,null,0,kn.a,[d.p,[2,cn.a]],{userId:[0,"userId"]},null),d._32(131072,H.a,[W.a,d.i]),(n()(),d._40(-1,null,["\n            "])),(n()(),d._16(33,0,null,null,1,"img",[["class","button core-bar-button-image"],["core-external-content",""],["onError","this.src='assets/img/user-avatar.png'"]],[[8,"src",4]],null,null,null,null)),d._15(34,4210688,null,0,Cn.a,[d.p,b.a,un.a,an.a,m.a,y.a,on.a,M.a],null,null),(n()(),d._40(-1,null,["\n        "])),(n()(),d._40(-1,0,["\n    "])),(n()(),d._40(-1,null,["\n"])),(n()(),d._40(-1,null,["\n"])),(n()(),d._16(39,0,null,null,24,"ion-content",[],[[2,"statusbar-padding",null],[2,"has-refresher",null]],null,null,xn.b,xn.a)),d._15(40,4374528,[[1,4]],0,dn.a,[$.a,an.a,Kn.a,d.p,d.K,vn.a,Ln.a,d.D,[2,hn.a],[2,cn.a]],null,null),(n()(),d._40(-1,1,["\n    "])),(n()(),d._16(42,0,null,1,20,"core-loading",[],null,null,null,Sn.b,Sn.a)),d._15(43,638976,null,0,Un.a,[W.a,d.p],{hideUntil:[0,"hideUntil"]},null),(n()(),d._40(-1,0,["\n        "])),(n()(),d._40(-1,0,["\n        "])),(n()(),d._16(46,0,null,0,5,"ion-infinite-scroll",[["position","top"]],null,[[null,"ionInfinite"]],function(n,l,e){var t=!0;if("ionInfinite"===l){t=!1!==n.component.loadPrevious(e)&&t}return t},null,null)),d._15(47,1196032,null,0,En.a,[dn.a,d.D,d.p,Kn.a],{enabled:[0,"enabled"],position:[1,"position"]},{ionInfinite:"ionInfinite"}),(n()(),d._40(-1,null,["\n           "])),(n()(),d._16(49,0,null,null,1,"ion-infinite-scroll-content",[],[[1,"state",0]],null,null,Fn.b,Fn.a)),d._15(50,114688,null,0,Rn.a,[En.a,$.a],null,null),(n()(),d._40(-1,null,["\n        "])),(n()(),d._40(-1,0,["\n        "])),(n()(),d._16(53,0,null,0,5,"ion-list",[["class","addon-messages-discussion-container"]],[[1,"aria-live",0]],null,null,null,null)),d._15(54,16384,null,0,Tn.a,[$.a,d.p,d.K,an.a,An.l,Kn.a],null,null),(n()(),d._40(-1,null,["\n            "])),(n()(),d._11(16777216,null,null,1,null,u)),d._15(57,802816,null,0,Y.j,[d.W,d.T,d.v],{ngForOf:[0,"ngForOf"]},null),(n()(),d._40(-1,null,["\n        "])),(n()(),d._40(-1,0,["\n        "])),(n()(),d._11(16777216,null,0,1,null,r)),d._15(61,16384,null,0,Y.k,[d.W,d.T],{ngIf:[0,"ngIf"]},null),(n()(),d._40(-1,0,["\n    "])),(n()(),d._40(-1,1,["\n"])),(n()(),d._40(-1,null,["\n"])),(n()(),d._16(65,0,null,null,10,"ion-footer",[["class","footer-adjustable"],["color","light"]],null,null,null,null,null)),d._15(66,16384,null,0,Bn.a,[$.a,d.p,d.K,[2,hn.a]],{color:[0,"color"]},null),(n()(),d._40(-1,null,["\n    "])),(n()(),d._16(68,0,null,null,6,"ion-toolbar",[["class","toolbar"],["color","light"],["position","bottom"]],[[2,"statusbar-padding",null]],null,null,On.b,On.a)),d._15(69,49152,null,0,wn.a,[$.a,d.p,d.K],{color:[0,"color"]},null),(n()(),d._40(-1,3,["\n        "])),(n()(),d._16(71,0,null,3,2,"core-send-message-form",[],null,[[null,"onSubmit"],[null,"onResize"]],function(n,l,e){var t=!0,s=n.component;if("onSubmit"===l){t=!1!==s.sendMessage(e)&&t}if("onResize"===l){t=!1!==s.resizeContent()&&t}return t},Xn.b,Xn.a)),d._15(72,114688,null,0,zn.a,[v.a,sn.a],{placeholder:[0,"placeholder"],showKeyboard:[1,"showKeyboard"]},{onSubmit:"onSubmit",onResize:"onResize"}),d._32(131072,H.a,[W.a,d.i]),(n()(),d._40(-1,3,["\n    "])),(n()(),d._40(-1,null,["\n"])),(n()(),d._40(-1,null,["\n"]))],function(n,l){var e=l.component;n(l,11,0,e.title),n(l,19,0);n(l,23,0,"true");n(l,26,0,"trash");n(l,30,0,e.userId);n(l,43,0,e.loaded);n(l,47,0,e.canLoadMore,"top"),n(l,50,0);n(l,57,0,e.messages);n(l,61,0,!e.messages||e.messages.length<=0);n(l,66,0,"light");n(l,69,0,"light");n(l,72,0,d._41(l,72,0,d._29(l,73).transform("addon.messages.newmessage")),e.showKeyboard)},function(n,l){var e=l.component;n(l,5,0,d._29(l,6)._hidden,d._29(l,6)._sbPadding);n(l,22,0,!e.canDelete);n(l,25,0,d._29(l,26)._hidden);n(l,29,0,!e.showProfileLink,d._41(l,29,1,d._29(l,31).transform("core.user.viewprofile")));n(l,33,0,e.profileLink);n(l,39,0,d._29(l,40).statusbarPadding,d._29(l,40)._hasRefresher);n(l,49,0,d._29(l,50).inf.state);n(l,53,0,e.polite);n(l,68,0,d._29(l,69)._sbPadding)})}Object.defineProperty(l,"__esModule",{value:!0});var d=e(1),g=(e(0),e(10),e(6)),f=e(20),m=e(2),_=e(163),h=e(436),p=e(44),y=e(5),v=e(3),b=e(4),M=e(11),w=(e(1376),e(187)),I=e(13),P=function(){function n(n,l,e,t,s,a,o,i,u,r,c,d){var g=this;this.eventsProvider=n,this.userProvider=t,this.navCtrl=s,this.messagesSync=a,this.domUtils=o,this.messagesProvider=i,this.utils=r,this.appProvider=c,this.translate=d,this.unreadMessageFrom=0,this.messagesBeingSent=0,this.pagesLoaded=1,this.lastMessage={text:"",timecreated:0},this.keepMessageMap={},this.oldContentHeight=0,this.loaded=!1,this.showKeyboard=!1,this.canLoadMore=!1,this.messages=[],this.showDelete=!1,this.canDelete=!1,this.scrollBottom=!0,this.viewDestroyed=!1,this.siteId=l.getCurrentSiteId(),this.currentUserId=l.getCurrentSiteUserId(),this.logger=u.getInstance("AddonMessagesDiscussionPage"),this.userId=e.get("userId"),this.showKeyboard=e.get("showKeyboard"),this.syncObserver=n.on(h.a.AUTO_SYNCED,function(n){n.userId==g.userId&&(g.fetchData(),n.warnings&&n.warnings[0]&&g.domUtils.showErrorModal(n.warnings[0]))},this.siteId)}return n.prototype.addMessage=function(n,l){void 0===l&&(l=!0),n.hash=w.Md5.hashAsciiStr(n.smallmessage)+"#"+n.timecreated+"#"+n.useridfrom,void 0===this.keepMessageMap[n.hash]&&this.messages.push(n),this.keepMessageMap[n.hash]=l},n.prototype.removeMessage=function(n){if(this.keepMessageMap[n])this.keepMessageMap[n]=!1;else{delete this.keepMessageMap[n];var l=this.messages.findIndex(function(l){return l.hash==n});l>0&&this.messages.splice(l,1)}},n.prototype.ionViewDidLoad=function(){var n=this,l=this.navCtrl.getPrevious()&&this.navCtrl.getPrevious().component.name;this.showProfileLink=!l||"CoreUserProfilePage"!==l,this.userProvider.getProfile(this.userId,void 0,!0).then(function(l){n.title||(n.title=l.fullname),n.profileLink=l.profileimageurl}),this.messagesSync.syncDiscussion(this.userId).catch(function(){}).then(function(l){return l&&l[0]&&n.domUtils.showErrorModal(l[0]),n.fetchData().then(function(){!n.title&&n.messages.length&&(n.title=n.messages[0].useridto!=n.currentUserId?n.messages[0].usertofullname||"":n.messages[0].userfromfullname||"")}).catch(function(l){n.domUtils.showErrorModalDefault(l,"addon.messages.errorwhileretrievingmessages",!0)}).finally(function(){n.checkCanDelete(),n.resizeContent(),n.loaded=!0})}),this.keyboardObserver=this.eventsProvider.on(f.a.KEYBOARD_CHANGE,function(l){n.content.resize()})},n.prototype.ionViewDidEnter=function(){this.setPolling()},n.prototype.ionViewWillLeave=function(){this.unsetPolling()},n.prototype.fetchData=function(){var n=this;return this.logger.debug("Polling new messages for discussion with user '"+this.userId+"'"),this.messagesBeingSent>0?Promise.reject(null):this.fetching?Promise.reject(null):(this.fetching=!0,this.messagesSync.waitForSync(this.userId).then(function(){return n.messagesProvider.invalidateDiscussionCache(n.userId).catch(function(){})}).then(function(){return n.getDiscussion(n.pagesLoaded)}).then(function(l){if(n.viewDestroyed)return Promise.resolve();if(n.scrollBottom=n.content.scrollHeight-n.content.scrollTop===n.content.contentHeight,n.messagesBeingSent>0)return Promise.reject(null);l.forEach(function(l){n.addMessage(l)});for(var e in n.keepMessageMap)n.removeMessage(e);n.messagesProvider.sortMessages(n.messages),n.notifyNewMessage(),n.markMessagesAsRead()}).finally(function(){n.fetching=!1}))},n.prototype.getDiscussion=function(n,l,e,t,s){var a=this;void 0===l&&(l=0),void 0===e&&(e=0),void 0===t&&(t=0),void 0===s&&(s=0);return this.messagesProvider.getDiscussion(this.userId,l>0||e>0||t>0||s>0,l,e,t,s).then(function(o){return--n>0&&o.canLoadMore?(o.messages.forEach(function(n){n.pending||(n.useridfrom==a.userId?n.read?e++:l++:n.read?s++:t++)}),a.getDiscussion(n,l,e,t,s).then(function(n){return o.messages.concat(n)})):(a.canLoadMore=o.canLoadMore,o.messages)})},n.prototype.markMessagesAsRead=function(){var n=this,l=!1,e=[];if(this.messagesProvider.isMarkAllMessagesReadEnabled()){var t=!1;for(var s in this.messages){var a=this.messages[s];if(a.useridfrom!=this.currentUserId&&0==a.read){t=!0;break}}t&&(this.setUnreadLabelPosition(),e.push(this.messagesProvider.markAllMessagesRead(this.userId).then(function(){l=!0,n.messages.forEach(function(n){n.read=1})})))}else this.setUnreadLabelPosition(),this.messages.forEach(function(t){t.useridfrom!=n.currentUserId&&0==t.read&&e.push(n.messagesProvider.markMessageRead(t.id).then(function(){l=!0,t.read=1}))});Promise.all(e).finally(function(){l&&n.eventsProvider.trigger(_.a.READ_CHANGED_EVENT,{userId:n.userId},n.siteId)})},n.prototype.notifyNewMessage=function(){var n=this.messages[this.messages.length-1],l=!1;if(n?n.text===this.lastMessage.text&&n.timecreated===this.lastMessage.timecreated||(this.lastMessage={text:n.text,timecreated:n.timecreated},l=!0):(this.lastMessage={text:"",timecreated:0},l=!0),l){this.eventsProvider.trigger(_.a.NEW_MESSAGE_EVENT,{userId:this.userId,message:this.lastMessage.text,timecreated:this.lastMessage.timecreated},this.siteId);this.canDelete!=(n&&n.id&&1==this.messages.length||this.messages.length>1)&&this.checkCanDelete()}},n.prototype.setUnreadLabelPosition=function(){if(0==this.unreadMessageFrom){var n=!1;for(var l in this.messages){var e=this.messages[l];if(e.useridfrom!=this.currentUserId){if(e.unreadFrom=0==e.read&&n,e.unreadFrom){this.unreadMessageFrom=parseInt(e.id,10);break}n=0!=e.read}}0==this.unreadMessageFrom&&(this.unreadMessageFrom=-1)}},n.prototype.checkCanDelete=function(){var n=this.messages[0];this.canDelete=n&&!n.sending},n.prototype.hideUnreadLabel=function(){if(this.unreadMessageFrom>0){for(var n in this.messages){var l=this.messages[n];if(l.id==this.unreadMessageFrom){l.unreadFrom=!1;break}}this.unreadMessageFrom=-1}},n.prototype.waitForFetch=function(){var n=this;if(!this.fetching)return Promise.resolve();var l=this.utils.promiseDefer();return setTimeout(function(){return n.waitForFetch().finally(function(){l.resolve()})},400),l.promise},n.prototype.setPolling=function(){var n=this;this.polling||(this.polling=setInterval(function(){n.fetchData().catch(function(){})},_.a.POLL_INTERVAL))},n.prototype.unsetPolling=function(){this.polling&&(this.logger.debug("Cancelling polling for conversation with user '"+this.userId+"'"),clearInterval(this.polling),this.polling=void 0)},n.prototype.copyMessage=function(n){this.utils.copyToClipboard(n)},n.prototype.deleteMessage=function(n,l){var e=this;this.domUtils.showConfirm(this.translate.instant(n.pending?"core.areyousure":"addon.messages.deletemessageconfirmation")).then(function(){var t=e.domUtils.showModalLoading("core.deleting",!0);return e.messagesProvider.deleteMessage(n).then(function(){e.messages.splice(l,1),e.removeMessage(n.hash),e.notifyNewMessage(),e.fetchData()}).finally(function(){t.dismiss()})}).catch(function(n){e.domUtils.showErrorModalDefault(n,"addon.messages.errordeletemessage",!0)})},n.prototype.loadPrevious=function(n){var l=this;return this.waitForFetch().finally(function(){l.pagesLoaded++,l.fetchData().catch(function(n){l.pagesLoaded--,l.domUtils.showErrorModalDefault(n,"addon.messages.errorwhileretrievingmessages",!0)}).finally(function(){n.complete()})})},n.prototype.resizeContent=function(){var n=this,l=this.content.getContentDimensions().scrollTop;this.content.resize(),setTimeout(function(){!n.viewDestroyed&&n.content&&n.content.contentHeight!=n.oldContentHeight&&(l||(l=n.content.getContentDimensions().scrollTop),l+=n.oldContentHeight-n.content.contentHeight,n.oldContentHeight=n.content.contentHeight,n.content.scrollTo(0,l,0))})},n.prototype.scrollToBottom=function(){var n=this;this.scrollBottom&&(setTimeout(function(){n.viewDestroyed||n.content.scrollToBottom(0)}),this.scrollBottom=!1)},n.prototype.sendMessage=function(n){var l,e=this;this.hideUnreadLabel(),this.showDelete=!1,this.scrollBottom=!0,l={pending:!0,sending:!0,useridfrom:this.currentUserId,smallmessage:n,text:n,timecreated:(new Date).getTime()},this.addMessage(l,!1),this.messagesBeingSent++,this.waitForFetch().finally(function(){e.messagesProvider.sendMessage(e.userId,n).then(function(n){e.messagesBeingSent--,(n.sent?e.fetchData():Promise.reject(null)).catch(function(){l.sending=!1,n.sent?l.pending=!1:n.message&&(l.timecreated=n.message.timecreated),e.notifyNewMessage()})}).catch(function(n){e.messagesBeingSent--,e.appProvider.closeKeyboard(),e.domUtils.showErrorModalDefault(n,"addon.messages.messagenotsent",!0),e.removeMessage(l.hash)})})},n.prototype.showDate=function(n,l){return!l||!n.pending&&!I(n.timecreated).isSame(l.timecreated,"day")},n.prototype.toggleDelete=function(){this.showDelete=!this.showDelete},n.prototype.ngOnDestroy=function(){this.unsetPolling(),this.syncObserver&&this.syncObserver.off(),this.keyboardObserver&&this.keyboardObserver.off(),this.viewDestroyed=!0},n}(),D=e(32),k=e(31),C=e(107),x=function(){return function(){}}(),K=e(1291),L=e(1292),S=e(1293),U=e(1294),E=e(1295),F=e(1296),R=e(1297),T=e(1298),A=e(1299),B=e(1302),O=e(1303),X=e(1304),z=e(685),$=e(7),N=e(59),H=e(28),W=e(17),V=e(40),j=e(216),G=e(45),q=e(39),Y=e(9),J=e(34),Q=e(1373),Z=e(21),nn=e(19),ln=e(29),en=e(33),tn=e(38),sn=e(12),an=e(14),on=e(24),un=e(16),rn=e(23),cn=e(22),dn=e(25),gn=e(160),fn=e(134),mn=e(328),_n=e(419),hn=e(35),pn=e(1300),yn=e(191),vn=e(27),bn=e(1301),Mn=e(327),wn=e(238),In=e(421),Pn=e(86),Dn=e(76),kn=e(242),Cn=e(158),xn=e(176),Kn=e(26),Ln=e(97),Sn=e(55),Un=e(49),En=e(219),Fn=e(431),Rn=e(247),Tn=e(79),An=e(36),Bn=e(660),On=e(1913),Xn=e(1919),zn=e(1317),$n=e(58),Nn=d._14({encapsulation:2,styles:[],data:{animation:[{type:7,name:"coreSlideInOut",definitions:[{type:1,expr:"void => fromLeft",animation:[{type:6,styles:{transform:"translateX(0)",opacity:1},offset:null},{type:4,styles:{type:5,steps:[{type:6,styles:{opacity:0,transform:"translateX(-100%)",offset:0},offset:null},{type:6,styles:{opacity:1,transform:"translateX(5%)",offset:.7},offset:null},{type:6,styles:{opacity:1,transform:"translateX(0)",offset:1},offset:null}]},timings:300}],options:null},{type:1,expr:"fromLeft => void",animation:[{type:6,styles:{transform:"translateX(-100%)",opacity:0},offset:null},{type:4,styles:{type:5,steps:[{type:6,styles:{opacity:1,transform:"translateX(0)",offset:0},offset:null},{type:6,styles:{opacity:1,transform:"translateX(5%)",offset:.3},offset:null},{type:6,styles:{opacity:0,transform:"translateX(-100%)",offset:1},offset:null}]},timings:300}],options:null},{type:1,expr:"void => fromRight",animation:[{type:6,styles:{transform:"translateX(0)",opacity:1},offset:null},{type:4,styles:{type:5,steps:[{type:6,styles:{opacity:0,transform:"translateX(100%)",offset:0},offset:null},{type:6,styles:{opacity:1,transform:"translateX(-5%)",offset:.7},offset:null},{type:6,styles:{opacity:1,transform:"translateX(0)",offset:1},offset:null}]},timings:300}],options:null},{type:1,expr:"fromRight => void",animation:[{type:6,styles:{transform:"translateX(-100%)",opacity:0},offset:null},{type:4,styles:{type:5,steps:[{type:6,styles:{opacity:1,transform:"translateX(0)",offset:0},offset:null},{type:6,styles:{opacity:1,transform:"translateX(-5%)",offset:.3},offset:null},{type:6,styles:{opacity:0,transform:"translateX(100%)",offset:1},offset:null}]},timings:300}],options:null}],options:{}}]}}),Hn=d._12("page-addon-messages-discussion",P,function(n){return d._42(0,[(n()(),d._16(0,0,null,null,1,"page-addon-messages-discussion",[],null,null,null,c,Nn)),d._15(1,180224,null,0,P,[f.a,m.a,$n.a,p.a,cn.a,h.a,y.a,_.a,b.a,v.a,M.a,W.a],null,null)],null,null)},{},{},[]),Wn=e(18),Vn=e(323),jn=e(324),Gn=e(326),qn=e(325),Yn=e(418),Jn=e(192),Qn=e(420),Zn=e(240),nl=e(641),ll=e(239);e.d(l,"AddonMessagesDiscussionPageModuleNgFactory",function(){return el});var el=d._13(x,[],function(n){return d._25([d._26(512,d.n,d._6,[[8,[K.a,L.a,S.a,U.a,E.a,F.a,R.a,T.a,A.a,B.a,O.a,X.a,Hn]],[3,d.n],d.B]),d._26(4608,Y.m,Y.l,[d.x,[2,Y.v]]),d._26(4608,Wn.x,Wn.x,[]),d._26(4608,Wn.d,Wn.d,[]),d._26(4608,Vn.b,Vn.a,[]),d._26(4608,jn.a,jn.b,[]),d._26(4608,Gn.b,Gn.a,[]),d._26(4608,qn.b,qn.a,[]),d._26(4608,W.a,W.a,[Yn.a,Vn.b,jn.a,Gn.b,qn.b,W.b,W.c]),d._26(4608,Jn.a,Jn.a,[]),d._26(4608,Qn.a,Qn.a,[]),d._26(4608,Zn.a,Zn.a,[]),d._26(512,Y.b,Y.b,[]),d._26(512,Wn.v,Wn.v,[]),d._26(512,Wn.i,Wn.i,[]),d._26(512,Wn.s,Wn.s,[]),d._26(512,nl.a,nl.a,[]),d._26(512,g.a,g.a,[]),d._26(512,k.a,k.a,[]),d._26(512,C.a,C.a,[]),d._26(512,D.a,D.a,[]),d._26(512,nl.b,nl.b,[]),d._26(512,x,x,[]),d._26(256,W.c,void 0,[]),d._26(256,W.b,void 0,[]),d._26(256,ll.a,P,[])])})},1913:function(n,l,e){"use strict";function t(n){return s._42(2,[(n()(),s._16(0,0,null,null,1,"div",[["class","toolbar-background"]],null,null,null,null,null)),s._15(1,278528,null,0,a.i,[s.v,s.w,s.p,s.L],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),s._28(null,0),s._28(null,1),s._28(null,2),(n()(),s._16(5,0,null,null,2,"div",[["class","toolbar-content"]],null,null,null,null,null)),s._15(6,278528,null,0,a.i,[s.v,s.w,s.p,s.L],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),s._28(null,3)],function(n,l){var e=l.component;n(l,1,0,"toolbar-background","toolbar-background-"+e._mode);n(l,6,0,"toolbar-content","toolbar-content-"+e._mode)},null)}e.d(l,"a",function(){return o}),l.b=t;var s=e(1),a=e(9),o=(e(7),s._14({encapsulation:2,styles:[],data:{}}))},1919:function(n,l,e){"use strict";function t(n){return s._42(0,[(n()(),s._16(0,0,null,null,27,"form",[["novalidate",""]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"ngSubmit"],[null,"submit"],[null,"reset"]],function(n,l,e){var t=!0,a=n.component;if("submit"===l){t=!1!==s._29(n,2).onSubmit(e)&&t}if("reset"===l){t=!1!==s._29(n,2).onReset()&&t}if("ngSubmit"===l){t=!1!==a.submitForm(e)&&t}return t},null,null)),s._15(1,16384,null,0,a.w,[],null,null),s._15(2,4210688,null,0,a.p,[[8,null],[8,null]],null,{ngSubmit:"ngSubmit"}),s._35(2048,null,a.b,null,[a.p]),s._15(4,16384,null,0,a.o,[a.b],null,null),(n()(),s._40(-1,null,["\n    "])),(n()(),s._16(6,0,null,null,7,"textarea",[["class","core-send-message-input"],["core-auto-rows",""],["name","message"],["rows","1"]],[[8,"placeholder",0],[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"ngModelChange"],[null,"onResize"],[null,"input"],[null,"blur"],[null,"compositionstart"],[null,"compositionend"],[null,"change"]],function(n,l,e){var t=!0,a=n.component;if("input"===l){t=!1!==s._29(n,7)._handleInput(e.target.value)&&t}if("blur"===l){t=!1!==s._29(n,7).onTouched()&&t}if("compositionstart"===l){t=!1!==s._29(n,7)._compositionStart()&&t}if("compositionend"===l){t=!1!==s._29(n,7)._compositionEnd(e.target.value)&&t}if("input"===l){t=!1!==s._29(n,13).onInput()&&t}if("change"===l){t=!1!==s._29(n,13).onChange()&&t}if("ngModelChange"===l){t=!1!==(a.message=e)&&t}if("onResize"===l){t=!1!==a.textareaResized()&&t}return t},null,null)),s._15(7,16384,null,0,a.c,[s.L,s.p,[2,a.a]],null,null),s._35(1024,null,a.l,function(n){return[n]},[a.c]),s._15(9,671744,null,0,a.q,[[2,a.b],[8,null],[8,null],[2,a.l]],{name:[0,"name"],model:[1,"model"]},{update:"ngModelChange"}),s._35(2048,null,a.m,null,[a.q]),s._15(11,16384,null,0,a.n,[a.m],null,null),s._15(12,81920,null,0,o.a,[s.p,i.a,u.a,[2,r.a]],{coreAutoFocus:[0,"coreAutoFocus"]},null),s._15(13,4210688,null,0,c.a,[s.p],null,{onResize:"onResize"}),(n()(),s._40(-1,null,["\n    "])),(n()(),s._16(15,0,null,null,11,"ion-buttons",[["end",""]],null,null,null,null,null)),s._15(16,16384,null,1,d.a,[g.a,s.p,s.K,[2,f.a],[2,m.a]],null,null),s._37(603979776,1,{_buttons:1}),(n()(),s._40(-1,null,["\n        "])),(n()(),s._16(19,0,null,null,6,"button",[["clear","true"],["icon-only",""],["ion-button",""],["type","submit"]],[[8,"disabled",0],[1,"aria-label",0]],null,null,_.b,_.a)),s._15(20,1097728,[[1,4]],0,h.a,[[8,""],g.a,s.p,s.K],{clear:[0,"clear"]},null),s._32(131072,p.a,[y.a,s.i]),(n()(),s._40(-1,0,["\n            "])),(n()(),s._16(23,0,null,0,1,"ion-icon",[["color","dark"],["name","send"],["role","img"]],[[2,"hide",null]],null,null,null,null)),s._15(24,147456,null,0,v.a,[g.a,s.p,s.K],{color:[0,"color"],name:[1,"name"]},null),(n()(),s._40(-1,0,["\n        "])),(n()(),s._40(-1,null,["\n    "])),(n()(),s._40(-1,null,["\n"])),(n()(),s._40(-1,null,["\n"]))],function(n,l){var e=l.component;n(l,9,0,"message",e.message);n(l,12,0,e.showKeyboard);n(l,20,0,"true");n(l,24,0,"dark","send")},function(n,l){var e=l.component;n(l,0,0,s._29(l,4).ngClassUntouched,s._29(l,4).ngClassTouched,s._29(l,4).ngClassPristine,s._29(l,4).ngClassDirty,s._29(l,4).ngClassValid,s._29(l,4).ngClassInvalid,s._29(l,4).ngClassPending);n(l,6,0,e.placeholder,s._29(l,11).ngClassUntouched,s._29(l,11).ngClassTouched,s._29(l,11).ngClassPristine,s._29(l,11).ngClassDirty,s._29(l,11).ngClassValid,s._29(l,11).ngClassInvalid,s._29(l,11).ngClassPending);n(l,19,0,!e.message,s._41(l,19,1,s._29(l,21).transform("core.send")));n(l,23,0,s._29(l,24)._hidden)})}e.d(l,"a",function(){return b}),l.b=t;var s=e(1),a=e(18),o=e(330),i=e(5),u=e(3),r=e(22),c=e(340),d=e(421),g=e(7),f=e(238),m=e(191),_=e(45),h=e(39),p=e(28),y=e(17),v=e(40),b=(e(12),s._14({encapsulation:2,styles:[],data:{}}))}});