webpackJsonp([102],{1805:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),i.d(e,"AddonModAssignEditPageModule",function(){return c});var s=i(0),n=i(4),o=i(1),a=i(16),r=i(15),u=i(933),d=i(1929),l=this&&this.__decorate||function(t,e,i,s){var n,o=arguments.length,a=o<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(a=(o<3?n(a):o>3?n(e,i,a):n(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},c=function(){function t(){}return t=l([Object(s.I)({declarations:[d.a],imports:[a.a,r.a,u.a,n.l.forChild(d.a),o.b.forChild()]})],t)}()},1929:function(t,e,i){"use strict";i.d(e,"a",function(){return b});var s=i(0),n=i(4),o=i(1),a=i(12),r=i(2),u=i(45),d=i(8),l=i(107),c=i(52),f=i(80),m=i(255),h=i(108),g=this&&this.__decorate||function(t,e,i,s){var n,o=arguments.length,a=o<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(a=(o<3?n(a):o>3?n(e,i,a):n(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},p=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},b=function(){function t(t,e,i,s,n,o,a,r,u,d,l,c){this.navCtrl=e,this.sitesProvider=i,this.syncProvider=s,this.domUtils=n,this.translate=o,this.fileUploaderHelper=a,this.eventsProvider=r,this.assignProvider=u,this.assignOfflineProvider=d,this.assignHelper=l,this.assignSyncProvider=c,this.saveOffline=!1,this.hasOffline=!1,this.isDestroyed=!1,this.forceLeave=!1,this.moduleId=t.get("moduleId"),this.courseId=t.get("courseId"),this.userId=i.getCurrentSiteUserId(),this.isBlind=!!t.get("blindId"),this.editText=o.instant("addon.mod_assign.editsubmission"),this.title=this.editText}return t.prototype.ngOnInit=function(){var t=this;this.fetchAssignment().finally(function(){t.loaded=!0})},t.prototype.ionViewCanLeave=function(){var t=this;return!!this.forceLeave||this.hasDataChanged().then(function(e){if(e)return t.domUtils.showConfirm(t.translate.instant("core.confirmcanceledit"))}).then(function(){t.assignHelper.clearSubmissionPluginTmpData(t.assign,t.userSubmission,t.getInputData())})},t.prototype.fetchAssignment=function(){var t=this,e=this.sitesProvider.getCurrentSiteUserId();return this.assignProvider.getAssignment(this.courseId,this.moduleId).then(function(e){return t.assign=e,t.title=e.name||t.title,t.isDestroyed||t.syncProvider.blockOperation(c.a.COMPONENT,e.id),t.assignSyncProvider.waitForSync(e.id)}).then(function(){return t.assignProvider.getSubmissionStatus(t.assign.id,t.userId,t.isBlind,!1,!0).catch(function(e){return t.assignProvider.getSubmissionStatus(t.assign.id,t.userId,t.isBlind).then(function(i){var s=t.assignProvider.getSubmissionObjectFromAttempt(t.assign,i.lastattempt);return t.assignHelper.canEditSubmissionOffline(t.assign,s).then(function(s){return s?i:(t.allowOffline=!1,Promise.reject(e))})})}).then(function(i){return i.lastattempt.canedit?(t.userSubmission=t.assignProvider.getSubmissionObjectFromAttempt(t.assign,i.lastattempt),t.allowOffline=!0,t.submissionStatement=t.assign.requiresubmissionstatement&&!t.assign.submissiondrafts&&t.userId==e?t.assign.submissionstatement:void 0,t.assignOfflineProvider.getSubmission(t.assign.id,t.userId).then(function(e){t.hasOffline=e&&e.plugindata&&Object.keys(e.plugindata).length>0}).catch(function(){t.hasOffline=!1})):Promise.reject(t.translate.instant("core.nopermissions",{$a:t.editText}))})}).catch(function(e){t.domUtils.showErrorModalDefault(e,"Error getting assigment data."),t.leaveWithoutCheck()})},t.prototype.getInputData=function(){return this.domUtils.getDataFromForm(document.forms["addon-mod_assign-edit-form"])},t.prototype.hasDataChanged=function(){var t,e=this,i=!0;setTimeout(function(){i&&(t=e.domUtils.showModalLoading())},100);var s=this.getInputData();return this.assignHelper.hasSubmissionDataChanged(this.assign,this.userSubmission,s).finally(function(){t?t.dismiss():i=!1})},t.prototype.leaveWithoutCheck=function(){this.forceLeave=!0,this.navCtrl.pop()},t.prototype.prepareSubmissionData=function(t){var e=this;return this.saveOffline=this.hasOffline,this.assignHelper.prepareSubmissionPluginData(this.assign,this.userSubmission,t,this.hasOffline).catch(function(i){return e.allowOffline&&!e.saveOffline?(e.saveOffline=!0,e.assignHelper.prepareSubmissionPluginData(e.assign,e.userSubmission,t,!0)):Promise.reject(i)})},t.prototype.save=function(){var t=this;this.hasDataChanged().then(function(e){e?t.saveSubmission().then(function(){t.leaveWithoutCheck()}).catch(function(e){t.domUtils.showErrorModalDefault(e,"Error saving submission.")}):t.leaveWithoutCheck()})},t.prototype.saveSubmission=function(){var t=this,e=this.getInputData();if(this.submissionStatement&&(!e.submissionstatement||"false"===e.submissionstatement))return Promise.reject(this.translate.instant("addon.mod_assign.acceptsubmissionstatement"));var i=this.domUtils.showModalLoading();return this.assignHelper.getSubmissionSizeForEdit(this.assign,this.userSubmission,e).catch(function(){return-1}).then(function(e){return i.dismiss(),t.fileUploaderHelper.confirmUploadFile(e,!0,t.allowOffline)}).then(function(){return i=t.domUtils.showModalLoading("core.sending",!0),t.prepareSubmissionData(e).then(function(e){if(Object.keys(e).length){return(t.saveOffline?t.assignOfflineProvider.saveSubmission(t.assign.id,t.courseId,e,t.userSubmission.timemodified,!t.assign.submissiondrafts,t.userId):t.assignProvider.saveSubmission(t.assign.id,t.courseId,e,t.allowOffline,t.userSubmission.timemodified,t.assign.submissiondrafts,t.userId)).then(function(){var e={assignmentId:t.assign.id,submissionId:t.userSubmission.id,userId:t.userId};t.eventsProvider.trigger(c.a.SUBMISSION_SAVED_EVENT,e,t.sitesProvider.getCurrentSiteId()),t.assign.submissiondrafts||t.eventsProvider.trigger(c.a.SUBMITTED_FOR_GRADING_EVENT,e,t.sitesProvider.getCurrentSiteId())})}})}).finally(function(){i.dismiss()})},t.prototype.ngOnDestroy=function(){this.isDestroyed=!0,this.assign&&this.syncProvider.unblockOperation(c.a.COMPONENT,this.assign.id)},t=g([Object(s.m)({selector:"page-addon-mod-assign-edit",template:'<ion-header>\n    <ion-navbar>\n        <ion-title><core-format-text [text]="title"></core-format-text></ion-title>\n\n        <ion-buttons end>\n            <button ion-button clear (click)="save()" [attr.aria-label]="\'core.save\' | translate">\n                {{ \'core.save\' | translate }}\n            </button>\n        </ion-buttons>\n    </ion-navbar>\n</ion-header>\n<ion-content>\n    <core-loading [hideUntil]="loaded">\n        <ion-list>\n            \x3c!-- @todo: plagiarism_print_disclosure --\x3e\n            <form name="addon-mod_assign-edit-form" *ngIf="userSubmission && userSubmission.plugins && userSubmission.plugins.length">\n                \x3c!-- Submission statement. --\x3e\n                <ion-item text-wrap *ngIf="submissionStatement">\n                    <ion-label><core-format-text [text]="submissionStatement"></core-format-text></ion-label>\n                    <ion-checkbox item-end name="submissionstatement" [(ngModel)]="submissionStatementAccepted"></ion-checkbox>\n\n                    \x3c!-- ion-checkbox doesn\'t use an input. Create a hidden input to hold the value. --\x3e\n                    <input item-content type="hidden" [ngModel]="submissionStatementAccepted" name="submissionstatement">\n                </ion-item>\n\n                <addon-mod-assign-submission-plugin *ngFor="let plugin of userSubmission.plugins" [assign]="assign" [submission]="userSubmission" [plugin]="plugin" [edit]="true" [allowOffline]="allowOffline"></addon-mod-assign-submission-plugin>\n            </form>\n        </ion-list>\n    </core-loading>\n</ion-content>\n'}),p("design:paramtypes",[n.r,n.q,r.a,u.a,d.a,o.c,l.a,a.a,c.a,f.a,h.a,m.a])],t)}()}});