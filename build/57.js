webpackJsonp([57],{1852:function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),o.d(e,"AddonModWorkshopEditSubmissionPageModule",function(){return c});var i=o(0),n=o(4),s=o(1),r=o(16),a=o(15),l=o(1978),h=this&&this.__decorate||function(t,e,o,i){var n,s=arguments.length,r=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,o,i);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(r=(s<3?n(r):s>3?n(e,o,r):n(e,o))||r);return s>3&&r&&Object.defineProperty(e,o,r),r},c=function(){function t(){}return t=h([Object(i.I)({declarations:[l.a],imports:[a.a,r.a,n.l.forChild(l.a),s.b.forChild()]})],t)}()},1978:function(t,e,o){"use strict";o.d(e,"a",function(){return g});var i=o(0),n=o(4),s=o(20),r=o(1),a=o(12),l=o(2),h=o(45),c=o(121),d=o(8),u=o(11),f=o(56),m=o(106),p=o(136),b=o(116),v=this&&this.__decorate||function(t,e,o,i){var n,s=arguments.length,r=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,o,i);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(r=(s<3?n(r):s>3?n(e,o,r):n(e,o))||r);return s>3&&r&&Object.defineProperty(e,o,r),r},w=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},g=function(){function t(t,e,o,i,n,r,a,l,h,c,d,u,f,p){this.fileUploaderProvider=o,this.workshopProvider=i,this.workshopOffline=n,this.workshopHelper=r,this.navCtrl=a,this.fileSessionprovider=l,this.syncProvider=h,this.textUtils=c,this.domUtils=d,this.fb=u,this.translate=f,this.eventsProvider=p,this.submission={id:0,title:"",content:"",attachmentfiles:[]},this.loaded=!1,this.component=m.a.COMPONENT,this.originalData={},this.hasOffline=!1,this.editing=!1,this.forceLeave=!1,this.isDestroyed=!1,this.module=t.get("module"),this.courseId=t.get("courseId"),this.access=t.get("access"),this.submissionId=t.get("submissionId"),this.workshopId=this.module.instance,this.componentId=this.module.id,this.userId=e.getCurrentSiteUserId(),this.siteId=e.getCurrentSiteId(),this.editForm=new s.c({}),this.editForm.addControl("title",this.fb.control("",s.h.required)),this.editForm.addControl("content",this.fb.control(""))}return t.prototype.ngOnInit=function(){this.isDestroyed||this.syncProvider.blockOperation(this.component,this.workshopId),this.fetchSubmissionData()},t.prototype.ionViewCanLeave=function(){var t=this;if(this.forceLeave)return!0;return(this.hasDataChanged()?this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit")):Promise.resolve()).then(function(){t.submission.attachmentfiles&&t.fileUploaderProvider.clearTmpFiles(t.submission.attachmentfiles)})},t.prototype.fetchSubmissionData=function(){var t=this;return this.workshopProvider.getWorkshop(this.courseId,this.module.id).then(function(e){if(t.workshop=e,t.submissionId>0)return t.editing=!0,t.workshopHelper.getSubmissionById(t.workshopId,t.submissionId).then(function(e){t.submission=e;t.userId==e.authorid&&t.access.cansubmit&&t.access.modifyingsubmissionallowed||t.forceLeavePage()});t.access.cansubmit&&t.access.creatingsubmissionallowed||t.forceLeavePage()}).then(function(){return t.workshopOffline.getSubmissions(t.workshopId).then(function(e){if(e&&e.length){t.hasOffline=!0;var o=t.workshopHelper.filterSubmissionActions(e,t.editing?t.submission.id:0);return t.workshopHelper.applyOfflineData(t.submission,o)}t.hasOffline=!1}).finally(function(){t.originalData.title=t.submission.title,t.originalData.content=t.submission.content,t.originalData.attachmentfiles=[],t.submission.attachmentfiles.forEach(function(e){var o;o=e.filename?e.filename:"/"==e.filepath[0]?e.filepath.substr(1):e.filepath,t.originalData.attachmentfiles.push({filename:o,fileurl:e.fileurl})})})}).then(function(){t.editForm.controls.title.setValue(t.submission.title),t.editForm.controls.content.setValue(t.submission.content);t.fileSessionprovider.setFiles(t.component,t.workshopId+"_"+(t.submission.id||"newsub"),t.submission.attachmentfiles||[]),t.loaded=!0}).catch(function(e){t.loaded=!1,t.domUtils.showErrorModalDefault(e,"core.course.errorgetmodule",!0),t.forceLeavePage()})},t.prototype.forceLeavePage=function(){this.forceLeave=!0,this.navCtrl.pop()},t.prototype.getInputData=function(){var t=this.editForm.value;return t.attachmentfiles=this.fileSessionprovider.getFiles(this.component,this.workshopId+"_"+(this.submission.id||"newsub"))||[],t},t.prototype.hasDataChanged=function(){if(!this.loaded)return!1;var t=this.getInputData();return!(!this.originalData||void 0===this.originalData.title)&&(this.originalData.title!=t.title||this.originalData.content!=t.content||this.fileUploaderProvider.areFileListDifferent(t.attachmentfiles,this.originalData.attachmentfiles))},t.prototype.refreshSubmission=function(t){var e=this;if(this.loaded){var o=[];o.push(this.workshopProvider.invalidateSubmissionData(this.workshopId,this.submission.id)),o.push(this.workshopProvider.invalidateSubmissionsData(this.workshopId)),Promise.all(o).finally(function(){return e.fetchSubmissionData()}).finally(function(){t.complete()})}},t.prototype.save=function(){var t=this;this.hasDataChanged()?this.saveSubmission().then(function(){t.forceLeavePage()}).catch(function(){}):this.forceLeavePage()},t.prototype.saveSubmission=function(){var t=this,e=this.getInputData();if(!e.title)return this.domUtils.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredtitle"),Promise.reject(null);if(!e.content)return this.domUtils.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredcontent"),Promise.reject(null);var o=!0,i=!1,n=this.domUtils.showModalLoading("core.sending",!0),s=this.submission.id;return e.content=this.textUtils.formatHtmlLines(e.content),o=!e.attachmentfiles.length,this.workshopHelper.uploadOrStoreSubmissionFiles(this.workshopId,this.submission.id,e.attachmentfiles,this.editing,i).catch(function(){return i=!0,o=!0,t.workshopHelper.uploadOrStoreSubmissionFiles(t.workshopId,t.submission.id,e.attachmentfiles,t.editing,i)}).then(function(n){return t.editing?i?t.workshopOffline.saveSubmission(t.workshopId,t.courseId,e.title,e.content,n,s,"update").then(function(){}):t.workshopProvider.updateSubmission(t.workshopId,s,t.courseId,e.title,e.content,n,void 0,o):i?t.workshopOffline.saveSubmission(t.workshopId,t.courseId,e.title,e.content,n,s,"add").then(function(){}):t.workshopProvider.addSubmission(t.workshopId,t.courseId,e.title,e.content,n,void 0,s,o)}).then(function(o){var i={workshopId:t.workshopId,cmId:t.module.cmid};o&&s&&(t.workshopOffline.deleteSubmissionAction(t.workshopId,s,t.editing?"update":"add"),t.workshopHelper.deleteSubmissionStoredFiles(t.workshopId,s,t.editing),i.submissionId=o);return(o?t.workshopProvider.invalidateSubmissionData(t.workshopId,o):Promise.resolve()).finally(function(){t.eventsProvider.trigger(m.a.SUBMISSION_CHANGED,i,t.siteId),t.fileUploaderProvider.clearTmpFiles(e.attachmentfiles)})}).catch(function(e){t.domUtils.showErrorModalDefault(e,"Cannot save submission")}).finally(function(){n.dismiss()})},t.prototype.ngOnDestroy=function(){this.isDestroyed=!0,this.syncProvider.unblockOperation(this.component,this.workshopId)},t=v([Object(i.m)({selector:"page-addon-mod-workshop-edit-submission",template:'<ion-header>\n    <ion-navbar>\n        <ion-title>{{ \'addon.mod_workshop.editsubmission\' | translate }}</ion-title>\n        <ion-buttons end>\n            <button ion-button clear (click)="save()" [attr.aria-label]="\'core.save\' | translate">\n                {{ \'core.save\' | translate }}\n            </button>\n        </ion-buttons>\n    </ion-navbar>\n</ion-header>\n<ion-content>\n    <ion-refresher [enabled]="loaded" (ionRefresh)="refreshSubmission($event)">\n        <ion-refresher-content pullingText="{{ \'core.pulltorefresh\' | translate }}"></ion-refresher-content>\n    </ion-refresher>\n    <core-loading [hideUntil]="loaded">\n        <form ion-list [formGroup]="editForm" *ngIf="workshop">\n            <ion-item text-wrap>\n                <ion-label stacked core-mark-required="true">{{ \'addon.mod_workshop.submissiontitle\' | translate }}</ion-label>\n                <ion-input name="title" type="text" [placeholder]="\'addon.mod_workshop.submissiontitle\' | translate" formControlName="title"></ion-input>\n            </ion-item>\n\n            <ion-item>\n                <ion-label stacked>{{ \'addon.mod_workshop.submissioncontent\' | translate }}</ion-label>\n                <core-rich-text-editor item-content [control]="editForm.controls[\'content\']" formControlName="content" [placeholder]="\'addon.mod_workshop.submissioncontent\' | translate"  name="content" [component]="component" [componentId]="componentId"></core-rich-text-editor>\n            </ion-item>\n\n            <core-attachments *ngIf="workshop.nattachments > 0" [files]="submission.attachmentfiles" [maxSize]="workshop.maxbytes" [maxSubmissions]="workshop.nattachments" [component]="component" [componentId]="workshop.cmid" allowOffline="true" [acceptedTypes]="workshop.submissionfiletypes"></core-attachments>\n        </form>\n    </core-loading>\n</ion-content>\n'}),w("design:paramtypes",[n.r,l.a,f.a,m.a,b.a,p.a,n.q,c.a,h.a,u.a,d.a,s.a,r.c,a.a])],t)}()}});