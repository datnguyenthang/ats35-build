webpackJsonp([93],{1815:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),r.d(e,"AddonModDataEditPageModule",function(){return p});var n=r(0),i=r(4),o=r(1),a=r(15),d=r(16),s=r(392),l=r(391),c=r(390),f=r(1939),u=this&&this.__decorate||function(t,e,r,n){var i,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var d=t.length-1;d>=0;d--)(i=t[d])&&(a=(o<3?i(a):o>3?i(e,r,a):i(e,r))||a);return o>3&&a&&Object.defineProperty(e,r,a),a},p=function(){function t(){}return t=u([Object(n.I)({declarations:[f.a],imports:[a.a,d.a,c.a,l.a,s.a,i.l.forChild(f.a),o.b.forChild()]})],t)}()},1939:function(t,e,r){"use strict";r.d(e,"a",function(){return E});var n=r(0),i=r(4),o=r(1),a=r(20),d=r(6),s=r(8),l=r(2),c=r(46),f=r(12),u=r(56),p=r(10),h=r(59),m=r(198),y=r(150),g=r(62),v=r(390),I=this&&this.__decorate||function(t,e,r,n){var i,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var d=t.length-1;d>=0;d--)(i=t[d])&&(a=(o<3?i(a):o>3?i(e,r,a):i(e,r))||a);return o>3&&a&&Object.defineProperty(e,r,a),a},b=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},E=function(){function t(t,e,r,n,i,o,d,s,l,c,f,u,p,m){this.utils=e,this.groupsProvider=r,this.domUtils=n,this.fieldsDelegate=i,this.courseProvider=o,this.dataProvider=d,this.dataOffline=s,this.dataHelper=l,this.navCtrl=f,this.translate=u,this.eventsProvider=p,this.fileUploaderProvider=m,this.offlineActions=[],this.fields={},this.fieldsArray=[],this.forceLeave=!1,this.title="",this.component=h.a.COMPONENT,this.loaded=!1,this.selectedGroup=0,this.cssClass="",this.cssTemplate="",this.editFormRender="",this.extraImports=[v.a],this.errors={},this.module=t.get("module")||{},this.entryId=t.get("entryId")||null,this.courseId=t.get("courseId"),this.selectedGroup=t.get("group")||0,this.siteId=c.getCurrentSiteId(),this.title=this.module.name,this.editForm=new a.c({})}return t.prototype.ionViewDidLoad=function(){this.fetchEntryData()},t.prototype.ionViewCanLeave=function(){var t=this;if(this.forceLeave)return!0;var e=this.editForm.value;return this.dataHelper.hasEditDataChanged(e,this.fieldsArray,this.data.id,this.entry.contents).then(function(e){return e?t.domUtils.showConfirm(t.translate.instant("core.confirmcanceledit")):Promise.resolve()}).then(function(){return t.dataHelper.getEditTmpFiles(e,t.fieldsArray,t.data.id,t.entry.contents).then(function(e){t.fileUploaderProvider.clearTmpFiles(e)})})},t.prototype.fetchEntryData=function(){var t=this;return this.dataProvider.getDatabase(this.courseId,this.module.id).then(function(e){return t.title=e.name||t.title,t.data=e,t.cssClass="addon-data-entries-"+e.id,t.dataProvider.getDatabaseAccessInformation(e.id)}).then(function(e){if(t.cssTemplate=t.dataHelper.prefixCSS(t.data.csstemplate,"."+t.cssClass),t.entryId)return t.groupsProvider.getActivityGroupInfo(t.data.coursemodule,e.canmanageentries).then(function(e){t.groupInfo=e,e&&e.groups&&e.groups.length>0&&(e.groups.some(function(e){return t.selectedGroup==e.id})||(t.selectedGroup=e.groups[0].id))})}).then(function(){return t.dataOffline.getEntryActions(t.data.id,t.entryId)}).then(function(e){return t.offlineActions=e,t.dataProvider.getFields(t.data.id)}).then(function(e){return t.fieldsArray=e,t.fields=t.utils.arrayToObject(e,"id"),t.dataHelper.getEntry(t.data,t.entryId,t.offlineActions)}).then(function(e){return e?(e=e.entry).contents=t.utils.arrayToObject(e.contents,"fieldid"):e={contents:{}},t.dataHelper.applyOfflineActions(e,t.offlineActions,t.fieldsArray)}).then(function(e){t.entry=e,t.editFormRender=t.displayEditFields()}).catch(function(e){t.domUtils.showErrorModalDefault(e,"core.course.errorgetmodule",!0)}).finally(function(){t.loaded=!0})},t.prototype.save=function(){var t=this,e=this.editForm.value;return this.dataHelper.hasEditDataChanged(e,this.fieldsArray,this.data.id,this.entry.contents).then(function(r){if(!r)return t.entryId?t.returnToEntryList():Promise.reject("addon.mod_data.emptyaddform");var n=t.domUtils.showModalLoading("core.sending",!0),i=t.entryId?t.entryId:-(new Date).getTime();return t.dataHelper.getEditDataFromForm(e,t.fieldsArray,t.data.id,i,t.entry.contents,t.offline).catch(function(r){return t.offline?Promise.reject(r):(t.offline=!0,t.dataHelper.getEditDataFromForm(e,t.fieldsArray,t.data.id,i,t.entry.contents,t.offline))}).then(function(e){return e.length>0&&(t.entryId?t.dataProvider.editEntry(t.data.id,t.entryId,t.courseId,e,t.fields,void 0,t.offline):t.dataProvider.addEntry(t.data.id,i,t.courseId,e,t.selectedGroup,t.fields,void 0,t.offline))}).then(function(e){if(!e)return Promise.reject("addon.mod_data.emptyaddform");if(t.entryId&&e.updated||!t.entryId&&e.newentryid){var r=[];return t.entryId=t.entryId||e.newentryid,r.push(t.dataProvider.invalidateEntryData(t.data.id,t.entryId,t.siteId)),r.push(t.dataProvider.invalidateEntriesData(t.data.id,t.siteId)),Promise.all(r).then(function(){t.eventsProvider.trigger(h.a.ENTRY_CHANGED,{dataId:t.data.id,entryId:t.entryId},t.siteId)}).finally(function(){return t.returnToEntryList()})}t.errors={},e.fieldnotifications&&e.fieldnotifications.forEach(function(e){var r=t.fieldsArray.find(function(t){return t.name==e.fieldname});r&&(t.errors[r.id]=e.notification)}),t.jsData.errors=t.errors,setTimeout(function(){t.scrollToFirstError()})}).finally(function(){n.dismiss()})}).catch(function(e){return t.domUtils.showErrorModalDefault(e,"Cannot edit entry",!0),Promise.reject(null)})},t.prototype.setGroup=function(t){return this.selectedGroup=t,this.loaded=!1,this.fetchEntryData()},t.prototype.displayEditFields=function(){if(!this.data.addtemplate)return"";this.jsData={fields:this.fields,contents:this.entry.contents,form:this.editForm,data:this.data,errors:this.errors};var t,e=this.data.addtemplate;return this.fieldsArray.forEach(function(r){t=(t="[["+r.name+"]]").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t=new RegExp(t,"gi"),e=e.replace(t,'<addon-mod-data-field-plugin mode="edit" [field]="fields['+r.id+']"                [value]="contents['+r.id+']" [form]="form" [database]="data" [error]="errors['+r.id+']">                </addon-mod-data-field-plugin>'),t=(t="[["+r.name+"#id]]").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t=new RegExp(t,"gi"),e=e.replace(t,"field_"+r.id)}),e},t.prototype.returnToEntryList=function(){var t=this;return this.dataHelper.getEditTmpFiles(this.editForm.value,this.fieldsArray,this.data.id,this.entry.contents).then(function(e){t.fileUploaderProvider.clearTmpFiles(e)}).finally(function(){t.forceLeave=!0,t.navCtrl.pop()})},t.prototype.scrollToFirstError=function(){this.domUtils.scrollToElementBySelector(this.content,".addon-data-error")||this.content.scrollToTop()},I([Object(n._9)(i.f),b("design:type",i.f)],t.prototype,"content",void 0),t=I([Object(n.m)({selector:"page-addon-mod-data-edit",template:'<ion-header>\n    <ion-navbar>\n        <ion-title><core-format-text [text]="title"></core-format-text></ion-title>\n        <ion-buttons end>\n            <button ion-button clear (click)="save()" [attr.aria-label]="\'core.save\' | translate">\n                {{ \'core.save\' | translate }}\n            </button>\n        </ion-buttons>\n    </ion-navbar>\n</ion-header>\n<ion-content>\n    <core-loading [hideUntil]="loaded">\n        <ion-item text-wrap *ngIf="groupInfo && (groupInfo.separateGroups || groupInfo.visibleGroups)">\n            <ion-label id="addon-data-groupslabel" *ngIf="groupInfo.separateGroups">{{ \'core.groupsseparate\' | translate }}</ion-label>\n            <ion-label id="addon-data-groupslabel" *ngIf="groupInfo.visibleGroups">{{ \'core.groupsvisible\' | translate }}</ion-label>\n            <ion-select [(ngModel)]="selectedGroup" (ionChange)="setGroup(selectedGroup)" aria-labelledby="addon-data-groupslabel" interface="popover">\n                <ion-option *ngFor="let groupOpt of groupInfo.groups" [value]="groupOpt.id">{{groupOpt.name}}</ion-option>\n            </ion-select>\n        </ion-item>\n\n        <div class="addon-data-contents {{cssClass}}">\n            <style *ngIf="cssTemplate">\n                {{ cssTemplate }}\n            </style>\n\n            <form (ngSubmit)="save()" [formGroup]="editForm">\n                <core-compile-html [text]="editFormRender" [jsData]="jsData" [extraImports]="extraImports"></core-compile-html>\n            </form>\n        </div>\n    </core-loading>\n</ion-content>\n'}),b("design:paramtypes",[i.r,d.a,c.a,s.a,g.a,p.a,h.a,y.a,m.a,l.a,i.q,o.c,f.a,u.a])],t)}()}});