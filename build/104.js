webpackJsonp([104],{1801:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),s.d(t,"AddonMessagesDiscussionPageModule",function(){return h});var n=s(0),o=s(4),i=s(1),a=s(1925),r=s(16),c=s(15),d=s(66),l=this&&this.__decorate||function(e,t,s,n){var o,i=arguments.length,a=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,s,n);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(a=(i<3?o(a):i>3?o(t,s,a):o(t,s))||a);return i>3&&a&&Object.defineProperty(t,s,a),a},h=function(){function e(){}return e=l([Object(n.I)({declarations:[a.a],imports:[r.a,c.a,d.a,o.l.forChild(a.a),i.b.forChild()]})],e)}()},1925:function(e,t,s){"use strict";s.d(t,"a",function(){return M});var n=s(0),o=s(4),i=s(1),a=s(12),r=s(2),c=s(103),d=s(399),l=s(26),h=s(8),g=s(6),u=s(7),m=s(9),f=s(944),p=s(109),v=(s.n(p),s(5)),y=(s.n(v),this&&this.__decorate||function(e,t,s,n){var o,i=arguments.length,a=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,s,n);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(a=(i<3?o(a):i>3?o(t,s,a):o(t,s))||a);return i>3&&a&&Object.defineProperty(t,s,a),a}),b=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},M=function(){function e(e,t,s,n,o,i,a,r,c,l,h,g){var u=this;this.eventsProvider=e,this.userProvider=n,this.navCtrl=o,this.messagesSync=i,this.domUtils=a,this.messagesProvider=r,this.utils=l,this.appProvider=h,this.translate=g,this.unreadMessageFrom=0,this.messagesBeingSent=0,this.pagesLoaded=1,this.lastMessage={text:"",timecreated:0},this.keepMessageMap={},this.oldContentHeight=0,this.loaded=!1,this.showKeyboard=!1,this.canLoadMore=!1,this.messages=[],this.showDelete=!1,this.canDelete=!1,this.scrollBottom=!0,this.viewDestroyed=!1,this.siteId=t.getCurrentSiteId(),this.currentUserId=t.getCurrentSiteUserId(),this.logger=c.getInstance("AddonMessagesDiscussionPage"),this.userId=s.get("userId"),this.showKeyboard=s.get("showKeyboard"),this.syncObserver=e.on(d.a.AUTO_SYNCED,function(e){e.userId==u.userId&&(u.fetchData(),e.warnings&&e.warnings[0]&&u.domUtils.showErrorModal(e.warnings[0]))},this.siteId)}return e.prototype.addMessage=function(e,t){void 0===t&&(t=!0),e.hash=p.Md5.hashAsciiStr(e.smallmessage)+"#"+e.timecreated+"#"+e.useridfrom,void 0===this.keepMessageMap[e.hash]&&this.messages.push(e),this.keepMessageMap[e.hash]=t},e.prototype.removeMessage=function(e){if(this.keepMessageMap[e])this.keepMessageMap[e]=!1;else{delete this.keepMessageMap[e];var t=this.messages.findIndex(function(t){return t.hash==e});t>0&&this.messages.splice(t,1)}},e.prototype.ionViewDidLoad=function(){var e=this,t=this.navCtrl.getPrevious()&&this.navCtrl.getPrevious().component.name;this.showProfileLink=!t||"CoreUserProfilePage"!==t,this.userProvider.getProfile(this.userId,void 0,!0).then(function(t){e.title||(e.title=t.fullname),e.profileLink=t.profileimageurl}),this.messagesSync.syncDiscussion(this.userId).catch(function(){}).then(function(t){return t&&t[0]&&e.domUtils.showErrorModal(t[0]),e.fetchData().then(function(){!e.title&&e.messages.length&&(e.title=e.messages[0].useridto!=e.currentUserId?e.messages[0].usertofullname||"":e.messages[0].userfromfullname||"")}).catch(function(t){e.domUtils.showErrorModalDefault(t,"addon.messages.errorwhileretrievingmessages",!0)}).finally(function(){e.checkCanDelete(),e.resizeContent(),e.loaded=!0})}),this.keyboardObserver=this.eventsProvider.on(a.a.KEYBOARD_CHANGE,function(t){e.content.resize()})},e.prototype.ionViewDidEnter=function(){this.setPolling()},e.prototype.ionViewWillLeave=function(){this.unsetPolling()},e.prototype.fetchData=function(){var e=this;return this.logger.debug("Polling new messages for discussion with user '"+this.userId+"'"),this.messagesBeingSent>0?Promise.reject(null):this.fetching?Promise.reject(null):(this.fetching=!0,this.messagesSync.waitForSync(this.userId).then(function(){return e.messagesProvider.invalidateDiscussionCache(e.userId).catch(function(){})}).then(function(){return e.getDiscussion(e.pagesLoaded)}).then(function(t){if(e.viewDestroyed)return Promise.resolve();if(e.scrollBottom=e.content.scrollHeight-e.content.scrollTop===e.content.contentHeight,e.messagesBeingSent>0)return Promise.reject(null);t.forEach(function(t){e.addMessage(t)});for(var s in e.keepMessageMap)e.removeMessage(s);e.messagesProvider.sortMessages(e.messages),e.notifyNewMessage(),e.markMessagesAsRead()}).finally(function(){e.fetching=!1}))},e.prototype.getDiscussion=function(e,t,s,n,o){var i=this;void 0===t&&(t=0),void 0===s&&(s=0),void 0===n&&(n=0),void 0===o&&(o=0);return this.messagesProvider.getDiscussion(this.userId,t>0||s>0||n>0||o>0,t,s,n,o).then(function(a){return--e>0&&a.canLoadMore?(a.messages.forEach(function(e){e.pending||(e.useridfrom==i.userId?e.read?s++:t++:e.read?o++:n++)}),i.getDiscussion(e,t,s,n,o).then(function(e){return a.messages.concat(e)})):(i.canLoadMore=a.canLoadMore,a.messages)})},e.prototype.markMessagesAsRead=function(){var e=this,t=!1,s=[];if(this.messagesProvider.isMarkAllMessagesReadEnabled()){var n=!1;for(var o in this.messages){var i=this.messages[o];if(i.useridfrom!=this.currentUserId&&0==i.read){n=!0;break}}n&&(this.setUnreadLabelPosition(),s.push(this.messagesProvider.markAllMessagesRead(this.userId).then(function(){t=!0,e.messages.forEach(function(e){e.read=1})})))}else this.setUnreadLabelPosition(),this.messages.forEach(function(n){n.useridfrom!=e.currentUserId&&0==n.read&&s.push(e.messagesProvider.markMessageRead(n.id).then(function(){t=!0,n.read=1}))});Promise.all(s).finally(function(){t&&e.eventsProvider.trigger(c.a.READ_CHANGED_EVENT,{userId:e.userId},e.siteId)})},e.prototype.notifyNewMessage=function(){var e=this.messages[this.messages.length-1],t=!1;if(e?e.text===this.lastMessage.text&&e.timecreated===this.lastMessage.timecreated||(this.lastMessage={text:e.text,timecreated:e.timecreated},t=!0):(this.lastMessage={text:"",timecreated:0},t=!0),t){this.eventsProvider.trigger(c.a.NEW_MESSAGE_EVENT,{userId:this.userId,message:this.lastMessage.text,timecreated:this.lastMessage.timecreated},this.siteId);this.canDelete!=(e&&e.id&&1==this.messages.length||this.messages.length>1)&&this.checkCanDelete()}},e.prototype.setUnreadLabelPosition=function(){if(0==this.unreadMessageFrom){var e=!1;for(var t in this.messages){var s=this.messages[t];if(s.useridfrom!=this.currentUserId){if(s.unreadFrom=0==s.read&&e,s.unreadFrom){this.unreadMessageFrom=parseInt(s.id,10);break}e=0!=s.read}}0==this.unreadMessageFrom&&(this.unreadMessageFrom=-1)}},e.prototype.checkCanDelete=function(){var e=this.messages[0];this.canDelete=e&&!e.sending},e.prototype.hideUnreadLabel=function(){if(this.unreadMessageFrom>0){for(var e in this.messages){var t=this.messages[e];if(t.id==this.unreadMessageFrom){t.unreadFrom=!1;break}}this.unreadMessageFrom=-1}},e.prototype.waitForFetch=function(){var e=this;if(!this.fetching)return Promise.resolve();var t=this.utils.promiseDefer();return setTimeout(function(){return e.waitForFetch().finally(function(){t.resolve()})},400),t.promise},e.prototype.setPolling=function(){var e=this;this.polling||(this.polling=setInterval(function(){e.fetchData().catch(function(){})},c.a.POLL_INTERVAL))},e.prototype.unsetPolling=function(){this.polling&&(this.logger.debug("Cancelling polling for conversation with user '"+this.userId+"'"),clearInterval(this.polling),this.polling=void 0)},e.prototype.copyMessage=function(e){this.utils.copyToClipboard(e)},e.prototype.deleteMessage=function(e,t){var s=this;this.domUtils.showConfirm(this.translate.instant(e.pending?"core.areyousure":"addon.messages.deletemessageconfirmation")).then(function(){var n=s.domUtils.showModalLoading("core.deleting",!0);return s.messagesProvider.deleteMessage(e).then(function(){s.messages.splice(t,1),s.removeMessage(e.hash),s.notifyNewMessage(),s.fetchData()}).finally(function(){n.dismiss()})}).catch(function(e){s.domUtils.showErrorModalDefault(e,"addon.messages.errordeletemessage",!0)})},e.prototype.loadPrevious=function(e){var t=this;return this.waitForFetch().finally(function(){t.pagesLoaded++,t.fetchData().catch(function(e){t.pagesLoaded--,t.domUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingmessages",!0)}).finally(function(){e.complete()})})},e.prototype.resizeContent=function(){var e=this,t=this.content.getContentDimensions().scrollTop;this.content.resize(),setTimeout(function(){!e.viewDestroyed&&e.content&&e.content.contentHeight!=e.oldContentHeight&&(t||(t=e.content.getContentDimensions().scrollTop),t+=e.oldContentHeight-e.content.contentHeight,e.oldContentHeight=e.content.contentHeight,e.content.scrollTo(0,t,0))})},e.prototype.scrollToBottom=function(){var e=this;this.scrollBottom&&(setTimeout(function(){e.viewDestroyed||e.content.scrollToBottom(0)}),this.scrollBottom=!1)},e.prototype.sendMessage=function(e){var t,s=this;this.hideUnreadLabel(),this.showDelete=!1,this.scrollBottom=!0,t={pending:!0,sending:!0,useridfrom:this.currentUserId,smallmessage:e,text:e,timecreated:(new Date).getTime()},this.addMessage(t,!1),this.messagesBeingSent++,this.waitForFetch().finally(function(){s.messagesProvider.sendMessage(s.userId,e).then(function(e){s.messagesBeingSent--,(e.sent?s.fetchData():Promise.reject(null)).catch(function(){t.sending=!1,e.sent?t.pending=!1:e.message&&(t.timecreated=e.message.timecreated),s.notifyNewMessage()})}).catch(function(e){s.messagesBeingSent--,s.appProvider.closeKeyboard(),s.domUtils.showErrorModalDefault(e,"addon.messages.messagenotsent",!0),s.removeMessage(t.hash)})})},e.prototype.showDate=function(e,t){return!t||!e.pending&&!v(e.timecreated).isSame(t.timecreated,"day")},e.prototype.toggleDelete=function(){this.showDelete=!this.showDelete},e.prototype.ngOnDestroy=function(){this.unsetPolling(),this.syncObserver&&this.syncObserver.off(),this.keyboardObserver&&this.keyboardObserver.off(),this.viewDestroyed=!0},y([Object(n._9)(o.f),b("design:type",o.f)],e.prototype,"content",void 0),e=y([Object(n.m)({selector:"page-addon-messages-discussion",template:'<ion-header>\n    <ion-navbar>\n        <ion-title><core-format-text [text]="title"></core-format-text></ion-title>\n        <ion-buttons end></ion-buttons>\n    </ion-navbar>\n    <core-navbar-buttons end>\n        <button ion-button icon-only clear="true" (click)="toggleDelete()" [hidden]="!canDelete">\n            <ion-icon name="trash"></ion-icon>\n        </button>\n        <a [hidden]="!showProfileLink" core-user-link [userId]="userId" [attr.aria-label]=" \'core.user.viewprofile\' | translate">\n            <img class="button core-bar-button-image" [src]="profileLink" core-external-content onError="this.src=\'assets/img/user-avatar.png\'">\n        </a>\n    </core-navbar-buttons>\n</ion-header>\n<ion-content>\n    <core-loading [hideUntil]="loaded">\n        \x3c!-- Load previous messages. --\x3e\n        <ion-infinite-scroll [enabled]="canLoadMore" (ionInfinite)="loadPrevious($event)" position="top">\n           <ion-infinite-scroll-content></ion-infinite-scroll-content>\n        </ion-infinite-scroll>\n        <ion-list class="addon-messages-discussion-container" [attr.aria-live]="polite">\n            <ng-container *ngFor="let message of messages; index as index; last as last">\n                <ion-chip *ngIf="showDate(message, messages[index - 1])" class="addon-messages-date" color="light">\n                    <ion-label>{{ message.timecreated | coreFormatDate: "LL" }}</ion-label>\n                </ion-chip>\n\n                <ion-chip class="addon-messages-unreadfrom" *ngIf="message.unreadFrom" color="light">\n                    <ion-label>{{ \'addon.messages.newmessages\' | translate:{$a: title} }}</ion-label>\n                    <ion-icon name="arrow-round-down"></ion-icon>\n                </ion-chip>\n\n                <ion-item text-wrap (longPress)="copyMessage(message.smallmessage)" class="addon-message" [class.addon-message-mine]="message.useridfrom == currentUserId" [@coreSlideInOut]="message.useridfrom == currentUserId ? \'\' : \'fromLeft\'">\n                    \x3c!-- Some messages have <p> and some others don\'t. Add a <p> so they all have same styles. --\x3e\n                    <p class="addon-message-text">\n                        <core-format-text (afterRender)="last && scrollToBottom()" [text]="message.text"></core-format-text>\n                    </p>\n                    <ion-note *ngIf="!message.pending">\n                        {{ message.timecreated | coreFormatDate: "dftimedate" }}\n                    </ion-note>\n                    <ion-note *ngIf="message.pending"><ion-icon name="time"></ion-icon></ion-note>\n\n                    <button ion-button icon-only clear="true" *ngIf="!message.sending && showDelete" (click)="deleteMessage(message, index)" class="addon-messages-delete-button" [@coreSlideInOut]="\'fromRight\'" [attr.aria-label]=" \'addon.messages.deletemessage\' | translate">\n                        <ion-icon name="trash" color="danger"></ion-icon>\n                    </button>\n                </ion-item>\n            </ng-container>\n        </ion-list>\n        <core-empty-box *ngIf="!messages || messages.length <= 0" icon="chatbubbles" [message]="\'addon.messages.nomessages\' | translate"></core-empty-box>\n    </core-loading>\n</ion-content>\n<ion-footer color="light" class="footer-adjustable">\n    <ion-toolbar color="light" position="bottom">\n        <core-send-message-form (onSubmit)="sendMessage($event)" [showKeyboard]="showKeyboard" [placeholder]="\'addon.messages.newmessage\' | translate" (onResize)="resizeContent()"></core-send-message-form>\n    </ion-toolbar>\n</ion-footer>\n',animations:[f.b]}),b("design:paramtypes",[a.a,r.a,o.r,l.a,o.q,d.a,h.a,c.a,u.a,g.a,m.a,i.c])],e)}()}});