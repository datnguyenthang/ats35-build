webpackJsonp([39],{1873:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i.d(t,"CoreEmulatorCaptureMediaPageModule",function(){return c});var a=i(0),n=i(4),o=i(2001),r=i(1),s=i(16),d=this&&this.__decorate||function(e,t,i,a){var n,o=arguments.length,r=o<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,a);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(r=(o<3?n(r):o>3?n(t,i,r):n(t,i))||r);return o>3&&r&&Object.defineProperty(t,i,r),r},c=function(){function e(){}return e=d([Object(a.I)({declarations:[o.a],imports:[s.a,n.l.forChild(o.a),r.b.forChild()]})],e)}()},2001:function(e,t,i){"use strict";i.d(t,"a",function(){return l});var a=i(0),n=i(4),o=i(27),r=i(8),s=i(11),d=i(22),c=this&&this.__decorate||function(e,t,i,a){var n,o=arguments.length,r=o<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,a);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(r=(o<3?n(r):o>3?n(t,i,r):n(t,i))||r);return o>3&&r&&Object.defineProperty(t,i,r),r},h=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},l=function(){function e(e,t,i,a,n,o,r){this.viewCtrl=e,this.domUtils=i,this.timeUtils=a,this.fileProvider=n,this.textUtils=o,this.cdr=r,this.window=window,this.type=t.get("type"),this.maxTime=t.get("maxTime"),this.facingMode=t.get("facingMode")||"environment",this.mimetype=t.get("mimetype"),this.extension=t.get("extension"),this.quality=t.get("quality")||.92,this.returnDataUrl=!!t.get("returnDataUrl")}return e.prototype.ngOnInit=function(){var e=this;this.initVariables();var t={video:!this.isAudio&&{facingMode:this.facingMode},audio:!this.isImage};navigator.mediaDevices.getUserMedia(t).then(function(t){var i=[];if(e.localMediaStream=t,e.isImage||(e.isVideo?e.previewMedia=e.previewVideo.nativeElement:(e.previewMedia=e.previewAudio.nativeElement,e.initAudioDrawer(e.localMediaStream),e.audioDrawer.start()),e.mediaRecorder=new e.window.MediaRecorder(e.localMediaStream,{mimeType:e.mimetype}),e.mediaRecorder.ondataavailable=function(e){e.data.size>0&&i.push(e.data)},e.mediaRecorder.onstop=function(){e.mediaBlob=new Blob(i),i=[],e.previewMedia.src=window.URL.createObjectURL(e.mediaBlob)}),e.isImage||e.isVideo){var a,n=!1;e.streamVideo.nativeElement.onloadedmetadata=function(){n||(n=!0,clearTimeout(a),e.readyToCapture=!0,e.streamVideo.nativeElement.onloadedmetadata=null,e.cdr.detectChanges())},e.streamVideo.nativeElement.src=window.URL.createObjectURL(e.localMediaStream),a=setTimeout(function(){n||(n=!0,e.dismissWithError(-1,"Cannot connect to webcam."))},1e4)}else e.readyToCapture=!0}).catch(function(t){e.dismissWithError(-1,t.message||t)})},e.prototype.initAudioDrawer=function(e){var t=!0,i=!1,a=new(this.window.AudioContext||this.window.webkitAudioContext),n=this.streamAudio.nativeElement.getContext("2d"),o=a.createMediaStreamSource(e),r=a.createAnalyser(),s=r.frequencyBinCount,d=new Uint8Array(s),c=this.streamAudio.nativeElement.width,h=this.streamAudio.nativeElement.height,l=function(){if(i&&(requestAnimationFrame(l),!(t=!t))){var e=c/s,a=0;r.getByteTimeDomainData(d),n.fillStyle="rgb(200, 200, 200)",n.fillRect(0,0,c,h),n.lineWidth=1,n.strokeStyle="rgb(0, 0, 0)",n.beginPath();for(var o=0;o<s;o++){var m=d[o]/128*h/2;0===o?n.moveTo(a,m):n.lineTo(a,m),a+=e}n.lineTo(c,h/2),n.stroke()}};r.fftSize=2048,o.connect(r),this.audioDrawer={start:function(){i||(i=!0,l())},stop:function(){i=!1}}},e.prototype.initVariables=function(){"captureimage"==this.type&&(this.isCaptureImage=!0,this.type="image"),"video"==this.type?(this.isVideo=!0,this.title="core.capturevideo"):"audio"==this.type?(this.isAudio=!0,this.title="core.captureaudio"):"image"==this.type&&(this.isImage=!0,this.title="core.captureimage")},e.prototype.actionClicked=function(){var e=this;if(this.isCapturing)this.stopCapturing(),this.cdr.detectChanges();else if(this.isImage){var t=this.streamVideo.nativeElement.videoWidth,i=this.streamVideo.nativeElement.videoHeight,a=this.domUtils.showModalLoading();this.imgCanvas.nativeElement.width=t,this.imgCanvas.nativeElement.height=i,this.imgCanvas.nativeElement.getContext("2d").drawImage(this.streamVideo.nativeElement,0,0,t,i),this.imgCanvas.nativeElement.toBlob(function(t){a.dismiss(),e.mediaBlob=t,e.previewImage.nativeElement.setAttribute("src",window.URL.createObjectURL(e.mediaBlob)),e.hasCaptured=!0},this.mimetype,this.quality)}else this.isCapturing=!0,this.resetChrono=!1,this.mediaRecorder.start(),this.cdr.detectChanges()},e.prototype.cancel=function(){this.dismissWithError(3,"Canceled.","Camera cancelled")},e.prototype.discard=function(){this.previewMedia&&this.previewMedia.pause(),this.streamVideo&&this.streamVideo.nativeElement.play(),this.audioDrawer&&this.audioDrawer.start(),this.hasCaptured=!1,this.isCapturing=!1,this.resetChrono=!0,delete this.mediaBlob,this.cdr.detectChanges()},e.prototype.dismissWithData=function(e){this.viewCtrl.dismiss(e,"success")},e.prototype.dismissWithError=function(e,t,i){this.viewCtrl.dismiss(this.isImage&&!this.isCaptureImage?i||t:{code:e,message:t},"error")},e.prototype.done=function(){var e=this;if(this.returnDataUrl)this.dismissWithData(this.imgCanvas.nativeElement.toDataURL(this.mimetype,this.quality));else if(this.mediaBlob){var t=this.type+"_"+this.timeUtils.readableTimestamp()+"."+this.extension,i=this.textUtils.concatenatePaths(o.a.TMPFOLDER,"media/"+t),a=this.domUtils.showModalLoading();this.fileProvider.writeFile(i,this.mediaBlob).then(function(t){e.isImage&&!e.isCaptureImage?e.dismissWithData(t.toURL()):(t.getFormatData=function(e,t){},e.dismissWithData([t]))}).catch(function(t){e.domUtils.showErrorModal(t)}).finally(function(){a.dismiss()})}else this.domUtils.showErrorModal("Please capture the media first.")},e.prototype.stopCapturing=function(){this.streamVideo&&this.streamVideo.nativeElement.pause(),this.audioDrawer&&this.audioDrawer.stop(),this.mediaRecorder&&this.mediaRecorder.stop(),this.isCapturing=!1,this.hasCaptured=!0},e.prototype.ngOnDestroy=function(){this.localMediaStream.getTracks().forEach(function(e){e.stop()}),this.streamVideo&&this.streamVideo.nativeElement.pause(),this.previewMedia&&this.previewMedia.pause(),this.audioDrawer&&this.audioDrawer.stop(),delete this.mediaBlob},c([Object(a._9)("streamVideo"),h("design:type",a.t)],e.prototype,"streamVideo",void 0),c([Object(a._9)("previewVideo"),h("design:type",a.t)],e.prototype,"previewVideo",void 0),c([Object(a._9)("imgCanvas"),h("design:type",a.t)],e.prototype,"imgCanvas",void 0),c([Object(a._9)("previewImage"),h("design:type",a.t)],e.prototype,"previewImage",void 0),c([Object(a._9)("streamAudio"),h("design:type",a.t)],e.prototype,"streamAudio",void 0),c([Object(a._9)("previewAudio"),h("design:type",a.t)],e.prototype,"previewAudio",void 0),e=c([Object(a.m)({selector:"page-core-emulator-capture-media",template:'<ion-header>\n    <ion-navbar>\n        <ion-buttons start>\n            <button ion-button (click)="cancel()">{{ \'core.cancel\' | translate }}</button>\n        </ion-buttons>\n\n        <ion-title>{{ title | translate }}</ion-title>\n\n        <ion-buttons end>\n            <button ion-button *ngIf="hasCaptured" (click)="done()">{{ \'core.done\' | translate }}</button>\n        </ion-buttons>\n    </ion-navbar>\n</ion-header>\n<ion-content>\n    <core-loading [hideUntil]="readyToCapture">\n        <div class="core-av-wrapper">\n            \x3c!-- Video stream for image and video. --\x3e\n            <video *ngIf="!isAudio" [hidden]="hasCaptured" class="core-webcam-stream" autoplay #streamVideo></video>\n\n            \x3c!-- For video recording, use 2 videos and show/hide them because a CSS rule caused problems with the controls. --\x3e\n            <video *ngIf="isVideo" [hidden]="!hasCaptured" class="core-webcam-video-captured" controls #previewVideo></video>\n\n            \x3c!-- Canvas to treat the image and an img to show the result. --\x3e\n            <canvas *ngIf="isImage" class="core-webcam-image-canvas" #imgCanvas></canvas>\n            <img *ngIf="isImage" [hidden]="!hasCaptured" class="core-webcam-image" alt="{{ \'core.capturedimage\' | translate }}" #previewImage>\n\n            \x3c!-- Canvas to show audio waves when recording audio and audio player to listen to the result. --\x3e\n            <div *ngIf="isAudio" class="core-audio-record-container">\n                <canvas [hidden]="hasCaptured" class="core-audio-canvas" #streamAudio></canvas>\n                <audio [hidden]="!hasCaptured" class="core-audio-captured" controls #previewAudio></audio>\n            </div>\n        </div>\n    </core-loading>\n</ion-content>\n\n<ion-footer>\n    <ion-row *ngIf="readyToCapture">\n        <ion-col></ion-col>\n        <ion-col text-center>\n            <button ion-button icon-only clear *ngIf="!hasCaptured" (click)="actionClicked()" [attr.aria-label]="title">\n                <ion-icon *ngIf="!isCapturing && isAudio" name="microphone"></ion-icon>\n                <ion-icon *ngIf="!isCapturing && isVideo" name="videocam"></ion-icon>\n                <ion-icon *ngIf="isImage" name="camera"></ion-icon>\n                <ion-icon *ngIf="isCapturing" name="square"></ion-icon>\n            </button>\n            <button ion-button icon-only clear *ngIf="hasCaptured" (click)="discard()" [attr.aria-label]="\'core.discard\' | translate">\n                <ion-icon name="trash"></ion-icon>\n            </button>\n        </ion-col>\n        <ion-col padding text-right class="chrono-container">\n            <core-chrono *ngIf="!isImage" [hidden]="hasCaptured" [running]="isCapturing" [reset]="resetChrono" [endTime]="maxTime" (onEnd)="stopCapturing()"></core-chrono>\n        </ion-col>\n    </ion-row>\n</ion-footer>\n\n'}),h("design:paramtypes",[n.B,n.r,r.a,d.a,o.a,s.a,a.j])],e)}()}});