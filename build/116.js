webpackJsonp([116],{1789:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"AddonCalendarListPageModule",function(){return f});var i=n(0),o=n(4),r=n(1),s=n(16),a=n(15),c=n(66),l=n(1913),d=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},f=function(){function e(){}return e=d([Object(i.I)({declarations:[l.a],imports:[s.a,a.a,c.a,o.l.forChild(l.a),r.b.forChild()]})],e)}()},1913:function(e,t,n){"use strict";n.d(t,"a",function(){return E});var i=n(0),o=n(4),r=n(1),s=n(249),a=n(934),c=n(41),l=n(8),d=n(6),f=n(2),u=n(78),h=n(945),v=n(12),g=n(9),p=n(133),y=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},m=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},E=function(){function e(e,t,n,i,o,r,a,c,l,d,f,u,h){var v=this;this.translate=e,this.calendarProvider=t,this.domUtils=i,this.coursesProvider=o,this.utils=r,this.calendarHelper=a,this.popoverCtrl=d,this.navCtrl=u,this.daysLoaded=0,this.emptyEventsTimes=0,this.categoriesRetrieved=!1,this.getCategories=!1,this.allCourses={id:-1,fullname:this.translate.instant("core.fulllistofcourses"),category:-1},this.categories={},this.eventsLoaded=!1,this.events=[],this.notificationsEnabled=!1,this.filteredEvents=[],this.canLoadMore=!1,this.filter={course:this.allCourses},this.siteHomeId=c.getCurrentSite().getSiteHomeId(),this.notificationsEnabled=l.isAvailable(),this.notificationsEnabled&&(this.obsDefaultTimeChange=f.on(s.a.DEFAULT_NOTIFICATION_TIME_CHANGED,function(){t.scheduleEventsNotifications(v.events)},c.getCurrentSiteId())),this.eventId=n.get("eventId")||!1}return e.prototype.ionViewDidLoad=function(){var e=this;this.eventId&&this.gotoEvent(this.eventId),this.fetchData().then(function(){!e.eventId&&e.splitviewCtrl.isOn()&&e.events.length>0&&e.gotoEvent(e.events[0].id)}).finally(function(){e.eventsLoaded=!0})},e.prototype.fetchData=function(e){var t=this;return void 0===e&&(e=!1),this.daysLoaded=0,this.emptyEventsTimes=0,this.coursesProvider.getUserCourses(!1).then(function(n){return n.unshift(t.allCourses),t.courses=n,t.fetchEvents(e)})},e.prototype.fetchEvents=function(e){var t=this;return void 0===e&&(e=!1),this.calendarProvider.getEventsList(this.daysLoaded,s.a.DAYS_INTERVAL).then(function(n){if(t.daysLoaded+=s.a.DAYS_INTERVAL,0===n.length){if(t.emptyEventsTimes++,!(t.emptyEventsTimes>5))return t.fetchEvents();t.canLoadMore=!1,e&&(t.events=[],t.filteredEvents=[])}else n.sort(function(e,t){return e.timestart-t.timestart}),n.forEach(t.calendarHelper.formatEventData.bind(t.calendarHelper)),t.getCategories=t.shouldLoadCategories(n),t.events=e?n:t.utils.mergeArraysWithoutDuplicates(t.events,n,"id"),t.filteredEvents=t.getFilteredEvents(),t.canLoadMore=!0,t.calendarProvider.scheduleEventsNotifications(t.events);t.content.resize()}).catch(function(e){t.domUtils.showErrorModalDefault(e,"addon.calendar.errorloadevents",!0),t.canLoadMore=!1}).then(function(){if(t.getCategories)return t.getCategories=!1,t.loadCategories()})},e.prototype.getFilteredEvents=function(){return-1==this.filter.course.id?this.events:this.events.filter(this.shouldDisplayEvent.bind(this))},e.prototype.shouldDisplayEvent=function(e){if("user"==e.eventtype||"site"==e.eventtype)return!0;if("category"==e.eventtype){if(!e.categoryid||!Object.keys(this.categories).length)return!0;if(e.categoryid==this.filter.course.category)return!0;for(var t=this.categories[this.filter.course.category];t&&t.parent;){if(e.categoryid==t.parent)return!0;t=this.categories[t.parent]}return!1}return e.courseid===this.siteHomeId||e.courseid==this.filter.course.id},e.prototype.shouldLoadCategories=function(e){if(this.categoriesRetrieved||this.getCategories)return this.getCategories;return e.some(function(e){return"undefined"!=e.categoryid&&e.categoryid>0})||this.getCategories},e.prototype.loadCategories=function(){var e=this;return this.coursesProvider.getCategories(0,!0).then(function(t){e.categoriesRetrieved=!0,e.categories={},t.forEach(function(t){e.categories[t.id]=t})}).catch(function(){})},e.prototype.refreshEvents=function(e){var t=this,n=[];n.push(this.calendarProvider.invalidateEventsList(this.courses)),this.categoriesRetrieved&&(n.push(this.coursesProvider.invalidateCategories(0,!0)),this.categoriesRetrieved=!1),Promise.all(n).finally(function(){t.fetchData(!0).finally(function(){e.complete()})})},e.prototype.openCourseFilter=function(e){var t=this,n=this.popoverCtrl.create(h.a,{courses:this.courses,courseId:this.filter.course.id});n.onDidDismiss(function(e){e&&(t.filter.course=e,t.content.scrollToTop(),t.filteredEvents=t.getFilteredEvents())}),n.present({ev:e})},e.prototype.openSettings=function(){this.navCtrl.push("AddonCalendarSettingsPage")},e.prototype.gotoEvent=function(e){this.eventId=e,this.splitviewCtrl.push("AddonCalendarEventPage",{id:e})},e.prototype.ngOnDestroy=function(){this.obsDefaultTimeChange&&this.obsDefaultTimeChange.off()},y([Object(i._9)(o.f),m("design:type",o.f)],e.prototype,"content",void 0),y([Object(i._9)(p.a),m("design:type",p.a)],e.prototype,"splitviewCtrl",void 0),e=y([Object(i.m)({selector:"page-addon-calendar-list",template:'<ion-header>\n    <ion-navbar>\n        <ion-title>{{ \'addon.calendar.calendarevents\' | translate }}</ion-title>\n        <ion-buttons end>\n            <button *ngIf="courses && courses.length" ion-button icon-only (click)="openCourseFilter($event)" [attr.aria-label]="\'core.courses.filter\' | translate">\n                <ion-icon name="funnel"></ion-icon>\n            </button>\n            <core-context-menu>\n                <core-context-menu-item [hidden]="!notificationsEnabled" [priority]="600" [content]="\'core.settings.settings\' | translate" (action)="openSettings()" [iconAction]="\'cog\'"></core-context-menu-item>\n            </core-context-menu>\n        </ion-buttons>\n    </ion-navbar>\n</ion-header>\n<core-split-view>\n    <ion-content>\n        <ion-refresher [enabled]="eventsLoaded" (ionRefresh)="refreshEvents($event)">\n            <ion-refresher-content pullingText="{{ \'core.pulltorefresh\' | translate }}"></ion-refresher-content>\n        </ion-refresher>\n        <core-loading [hideUntil]="eventsLoaded">\n            <core-empty-box *ngIf="!filteredEvents || !filteredEvents.length" icon="calendar" [message]="\'addon.calendar.noevents\' | translate">\n            </core-empty-box>\n\n            <ion-list *ngIf="filteredEvents && filteredEvents.length" no-margin>\n                <a ion-item text-wrap *ngFor="let event of filteredEvents" [title]="event.name" (click)="gotoEvent(event.id)" [class.core-split-item-selected]="event.id == eventId">\n                    <img *ngIf="event.moduleIcon" src="{{event.moduleIcon}}" item-start class="core-module-icon">\n                    <core-icon *ngIf="event.icon && !event.moduleIcon" [name]="event.icon" item-start></core-icon>\n                    <h2><core-format-text [text]="event.name"></core-format-text></h2>\n                    <p>{{ event.timestart | coreToLocaleString }}</p>\n                </a>\n            </ion-list>\n\n            <ion-infinite-scroll [enabled]="canLoadMore" (ionInfinite)="$event.waitFor(fetchEvents())">\n               <ion-infinite-scroll-content></ion-infinite-scroll-content>\n            </ion-infinite-scroll>\n        </core-loading>\n    </ion-content>\n</core-split-view>'}),m("design:paramtypes",[r.c,s.a,o.r,l.a,c.a,d.a,a.a,f.a,u.a,o.t,v.a,o.q,g.a])],e)}()}});