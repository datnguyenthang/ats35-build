webpackJsonp([3],{1855:function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),t.d(s,"AddonModWorkshopSubmissionPageModule",function(){return c});var o=t(0),n=t(4),i=t(1),r=t(16),a=t(15),d=t(394),l=t(1981),u=this&&this.__decorate||function(e,s,t,o){var n,i=arguments.length,r=i<3?s:null===o?o=Object.getOwnPropertyDescriptor(s,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,s,t,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(r=(i<3?n(r):i>3?n(s,t,r):n(s,t))||r);return i>3&&r&&Object.defineProperty(s,t,r),r},c=function(){function e(){}return e=u([Object(o.I)({declarations:[l.a],imports:[a.a,r.a,d.a,n.l.forChild(l.a),i.b.forChild()]})],e)}()},1981:function(e,s,t){"use strict";(function(e){t.d(s,"a",function(){return P});var o=t(0),n=t(4),i=t(20),r=t(1),a=t(12),d=t(2),l=t(45),u=t(8),c=t(11),h=t(10),m=t(26),f=t(115),p=t(969),b=t(106),v=t(136),g=t(116),I=t(253),w=this&&this.__decorate||function(e,s,t,o){var n,i=arguments.length,r=i<3?s:null===o?o=Object.getOwnPropertyDescriptor(s,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,s,t,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(r=(i<3?n(r):i>3?n(s,t,r):n(s,t))||r);return i>3&&r&&Object.defineProperty(s,t,r),r},k=this&&this.__metadata||function(e,s){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,s)},y=this&&this.__param||function(e,s){return function(t,o){s(t,o,e)}},P=function(){function s(e,s,t,o,n,r,a,d,l,u,c,h,m,f,p,v){var g=this;this.workshopProvider=t,this.workshopOffline=o,this.syncProvider=n,this.workshopHelper=r,this.navCtrl=a,this.textUtils=d,this.domUtils=l,this.fb=u,this.translate=c,this.eventsProvider=h,this.courseProvider=m,this.content=f,this.gradesHelper=p,this.userProvider=v,this.loaded=!1,this.ownAssessment=!1,this.canAddFeedback=!1,this.canEdit=!1,this.canDelete=!1,this.originalEvaluation={published:"",text:"",grade:""},this.hasOffline=!1,this.component=b.a.COMPONENT,this.forceLeave=!1,this.isDestroyed=!1,this.module=e.get("module"),this.workshop=e.get("workshop"),this.access=e.get("access"),this.courseId=e.get("courseId"),this.profile=e.get("profile"),this.submissionInfo=e.get("submission")||{},this.assessment=e.get("assessment")||null,this.title=this.module.name,this.workshopId=this.module.instance,this.currentUserId=s.getCurrentSiteUserId(),this.siteId=s.getCurrentSiteId(),this.submissionId=this.submissionInfo.submissionid||this.submissionInfo.id,this.userId=this.submissionInfo.userid||null,this.strategy=this.assessment&&this.assessment.strategy||this.workshop&&this.workshop.strategy,this.assessmentId=this.assessment&&(this.assessment.assessmentid||this.assessment.id),this.assessmentUserId=this.assessment&&(this.assessment.reviewerid||this.assessment.userid),this.feedbackForm=new i.c({}),this.feedbackForm.addControl("published",this.fb.control("")),this.feedbackForm.addControl("grade",this.fb.control("")),this.feedbackForm.addControl("text",this.fb.control("")),this.obsAssessmentSaved=this.eventsProvider.on(b.a.ASSESSMENT_SAVED,function(e){g.eventReceived(e)},this.siteId),this.syncObserver=this.eventsProvider.on(I.a.AUTO_SYNCED,function(e){g.eventReceived(e)},this.siteId)}return s.prototype.ngOnInit=function(){var e=this;this.fetchSubmissionData().then(function(){e.workshopProvider.logViewSubmission(e.submissionId).then(function(){e.courseProvider.checkModuleCompletion(e.courseId,e.module.completionstatus)})})},s.prototype.ionViewCanLeave=function(){var e=this.assessmentStrategy&&this.assessmentStrategy.hasDataChanged();return!(!this.forceLeave&&(this.hasEvaluationChanged()||e))||this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit"))},s.prototype.editSubmission=function(){this.navCtrl.push("AddonModWorkshopEditSubmissionPage",{module:e,access:this.access,courseid:this.courseId,submissionId:this.submission.id})},s.prototype.eventReceived=function(e){this.workshopId===e.workshopId&&(this.content&&this.content.scrollToTop(),this.loaded=!1,this.refreshAllData())},s.prototype.fetchSubmissionData=function(){var e=this;return this.workshopHelper.getSubmissionById(this.workshopId,this.submissionId).then(function(s){var t=[];if(e.submission=s,e.submission.attachmentfiles=s.attachmentfiles||[],e.submission.submissiongrade=e.submissionInfo&&e.submissionInfo.submissiongrade,e.submission.gradinggrade=e.submissionInfo&&e.submissionInfo.gradinggrade,e.submission.submissiongradeover=e.submissionInfo&&e.submissionInfo.submissiongradeover,e.userId=s.authorid||e.userId,e.canEdit=e.currentUserId==e.userId&&e.access.cansubmit&&e.access.modifyingsubmissionallowed,e.canDelete=e.access.candeletesubmissions,e.canAddFeedback=!e.assessmentId&&e.workshop.phase>b.a.PHASE_ASSESSMENT&&e.workshop.phase<b.a.PHASE_CLOSED&&e.access.canoverridegrades,e.ownAssessment=!1,e.access.canviewallassessments?t.push(e.workshopProvider.getSubmissionAssessments(e.workshopId,e.submissionId).then(function(s){e.canDelete&&(e.canDelete=!s.length),e.submissionInfo.reviewedby=s,e.submissionInfo.reviewedby.forEach(function(s){s.userid=s.reviewerid,s=e.workshopHelper.realGradeValue(e.workshop,s),e.currentUserId==s.userid&&(e.ownAssessment=s,s.ownAssessment=!0)})})):e.currentUserId==e.userId&&e.assessmentId&&t.push(e.workshopProvider.getAssessment(e.workshopId,e.assessmentId).then(function(s){e.canDelete&&(e.canDelete=!s),s.userid=s.reviewerid,s=e.workshopHelper.realGradeValue(e.workshop,s),e.currentUserId==s.userid&&(e.ownAssessment=s,s.ownAssessment=!0),e.submissionInfo.reviewedby=[s]})),(e.canAddFeedback||e.workshop.phase==b.a.PHASE_CLOSED)&&(e.evaluate={published:s.published,text:s.feedbackauthor||""}),e.canAddFeedback){e.isDestroyed||e.syncProvider.blockOperation(e.component,e.workshopId);var o=e.translate.instant("addon.mod_workshop.notoverridden");t.push(e.gradesHelper.makeGradesMenu(e.workshop.grade,e.workshopId,o,-1).then(function(s){return e.evaluationGrades=s,e.evaluate.grade={label:e.gradesHelper.getGradeLabelFromValue(s,e.submissionInfo.submissiongradeover)||o,value:e.submissionInfo.submissiongradeover||-1},e.workshopOffline.getEvaluateSubmission(e.workshopId,e.submissionId).then(function(t){e.hasOffline=!0,e.evaluate.published=t.published,e.evaluate.text=t.feedbacktext,e.evaluate.grade={label:e.gradesHelper.getGradeLabelFromValue(s,t.gradeover)||o,value:t.gradeover||-1}}).catch(function(){e.hasOffline=!1}).finally(function(){e.originalEvaluation.published=e.evaluate.published,e.originalEvaluation.text=e.evaluate.text,e.originalEvaluation.grade=e.evaluate.grade.value,e.feedbackForm.controls.published.setValue(e.evaluate.published),e.feedbackForm.controls.grade.setValue(e.evaluate.grade.value),e.feedbackForm.controls.text.setValue(e.evaluate.text)})}))}else e.workshop.phase==b.a.PHASE_CLOSED&&s.gradeoverby&&t.push(e.userProvider.getProfile(s.gradeoverby,e.courseId,!0).then(function(s){e.evaluateByProfile=s}));return e.assessmentId&&!e.access.assessingallowed&&e.assessment.feedbackreviewer&&e.assessment.gradinggradeoverby&&t.push(e.userProvider.getProfile(e.assessment.gradinggradeoverby,e.courseId,!0).then(function(s){e.evaluateGradingByProfile=s})),Promise.all(t)}).then(function(){return e.workshopOffline.getSubmissions(e.workshopId).then(function(s){var t=e.workshopHelper.filterSubmissionActions(s,e.submissionId);return e.workshopHelper.applyOfflineData(e.submission,t).then(function(s){e.submission=s})})}).catch(function(s){e.domUtils.showErrorModalDefault(s,"core.course.errorgetmodule",!0)}).finally(function(){e.loaded=!0})},s.prototype.forceLeavePage=function(){this.forceLeave=!0,this.navCtrl.pop()},s.prototype.hasEvaluationChanged=function(){if(!this.loaded||!this.access.canoverridegrades)return!1;var e=this.feedbackForm.value;return this.originalEvaluation.published!=e.published||(this.originalEvaluation.text!=e.text||this.originalEvaluation.grade!=e.grade)},s.prototype.refreshAllData=function(){var e=this,s=[];return s.push(this.workshopProvider.invalidateSubmissionData(this.workshopId,this.submissionId)),s.push(this.workshopProvider.invalidateSubmissionsData(this.workshopId)),s.push(this.workshopProvider.invalidateSubmissionAssesmentsData(this.workshopId,this.submissionId)),this.assessmentId&&(s.push(this.workshopProvider.invalidateAssessmentFormData(this.workshopId,this.assessmentId)),s.push(this.workshopProvider.invalidateAssessmentData(this.workshopId,this.assessmentId))),Promise.all(s).finally(function(){return e.eventsProvider.trigger(b.a.ASSESSMENT_INVALIDATED,e.siteId),e.fetchSubmissionData()})},s.prototype.refreshSubmission=function(e){this.loaded&&this.refreshAllData().finally(function(){e.complete()})},s.prototype.saveAssessment=function(){var e=this;this.assessmentStrategy&&this.assessmentStrategy.hasDataChanged()?this.assessmentStrategy.saveAssessment().then(function(){e.forceLeavePage()}).catch(function(){}):this.forceLeavePage()},s.prototype.saveEvaluation=function(){var e=this;this.hasEvaluationChanged()?this.sendEvaluation().then(function(){e.forceLeavePage()}):this.forceLeavePage()},s.prototype.sendEvaluation=function(){var e=this,s=this.domUtils.showModalLoading("core.sending",!0),t=this.feedbackForm.value;return t.grade=t.grade>=0?t.grade:"",t.text=this.textUtils.formatHtmlLines(t.text),this.workshopProvider.evaluateSubmission(this.workshopId,this.submissionId,this.courseId,t.text,t.published,t.grade).then(function(){var s={workshopId:e.workshopId,cmId:e.module.cmid,submissionId:e.submissionId};return e.workshopProvider.invalidateSubmissionData(e.workshopId,e.submissionId).finally(function(){e.eventsProvider.trigger(b.a.SUBMISSION_CHANGED,s,e.siteId)})}).catch(function(s){e.domUtils.showErrorModalDefault(s,"Cannot save submission evaluation")}).finally(function(){s.dismiss()})},s.prototype.deleteSubmission=function(){var e=this;this.domUtils.showConfirm(this.translate.instant("addon.mod_workshop.submissiondeleteconfirm")).then(function(){var s=e.domUtils.showModalLoading("core.deleting",!0),t=!1;e.workshopProvider.deleteSubmission(e.workshopId,e.submissionId,e.courseId).then(function(){return t=!0,e.workshopProvider.invalidateSubmissionData(e.workshopId,e.submissionId)}).catch(function(s){e.domUtils.showErrorModalDefault(s,"Cannot delete submission")}).finally(function(){if(s.dismiss(),t){e.eventsProvider.trigger(b.a.SUBMISSION_CHANGED,{workshopId:e.workshopId,cmId:e.module.cmid,submissionId:e.submissionId},e.siteId),e.forceLeavePage()}})})},s.prototype.undoDeleteSubmission=function(){var e=this;return this.workshopOffline.deleteSubmissionAction(this.workshopId,this.submissionId,"delete").finally(function(){return e.eventsProvider.trigger(b.a.SUBMISSION_CHANGED,{workshopId:e.workshopId,cmId:e.module.cmid,submissionId:e.submissionId},e.siteId),e.refreshAllData()})},s.prototype.ngOnDestroy=function(){this.isDestroyed=!0,this.syncObserver&&this.syncObserver.off(),this.obsAssessmentSaved&&this.obsAssessmentSaved.off(),this.syncProvider.unblockOperation(this.component,this.workshopId)},w([Object(o._9)(p.a),k("design:type",p.a)],s.prototype,"assessmentStrategy",void 0),s=w([Object(o.m)({selector:"page-addon-mod-workshop-submission-page",template:'<ion-header>\n    <ion-navbar>\n        <ion-title><core-format-text [text]="title"></core-format-text></ion-title>\n        <ion-buttons end [hidden]="!loaded">\n            <button *ngIf="assessmentId" ion-button clear (click)="saveAssessment()" [attr.aria-label]="\'core.save\' | translate">\n                {{ \'core.save\' | translate }}\n            </button>\n            <button *ngIf="canAddFeedback" ion-button clear (click)="saveEvaluation()" [attr.aria-label]="\'core.save\' | translate">\n                {{ \'core.save\' | translate }}\n            </button>\n        </ion-buttons>\n    </ion-navbar>\n</ion-header>\n<ion-content>\n    <ion-refresher [enabled]="loaded" (ionRefresh)="refreshSubmission($event)">\n        <ion-refresher-content pullingText="{{ \'core.pulltorefresh\' | translate }}"></ion-refresher-content>\n    </ion-refresher>\n    <core-loading [hideUntil]="loaded">\n        <ion-list *ngIf="submission">\n            <addon-mod-workshop-submission [submission]="submission" [courseId]="courseId" [module]="module" [workshop]="workshop" [access]="access"></addon-mod-workshop-submission>\n            <ion-item text-wrap *ngIf="canEdit || canDelete">\n                <button ion-button block icon-start *ngIf="canEdit" (click)="editSubmission()">\n                    <ion-icon name="create"></ion-icon>\n                    {{ \'addon.mod_workshop.editsubmission\' | translate }}\n                </button>\n                <button ion-button block icon-start *ngIf="!submission.deleted && canDelete" color="danger" (click)="deleteSubmission()">\n                    <ion-icon name="trash"></ion-icon>\n                    {{ \'addon.mod_workshop.deletesubmission\' | translate }}\n                </button>\n                <button ion-button block icon-start outline *ngIf="submission.deleted && canDelete" color="danger" (click)="undoDeleteSubmission()">\n                    <ion-icon name="undo"></ion-icon>\n                    {{ \'core.restore\' | translate }}\n                </button>\n            </ion-item>\n        </ion-list>\n\n        <ion-list *ngIf="!canAddFeedback && evaluate && evaluate.text">\n            <ion-item text-wrap>\n                <ion-avatar item-start *ngIf="evaluateByProfile">\n                    <img [src]="evaluateByProfile.profileimageurl" core-external-content core-user-link [courseId]="courseId" [userId]="evaluateByProfile.id" [alt]="\'core.pictureof\' | translate:{$a: evaluateByProfile.fullname}" role="presentation" onError="this.src=\'assets/img/user-avatar.png\'">\n                </ion-avatar>\n                <h2 *ngIf="evaluateByProfile && evaluateByProfile.fullname">{{ \'addon.mod_workshop.feedbackby\' | translate : {$a: evaluateByProfile.fullname} }}</h2>\n                <core-format-text [text]="evaluate.text"></core-format-text>\n            </ion-item>\n        </ion-list>\n\n        <ion-list *ngIf="ownAssessment && !assessment">\n            <ion-item text-wrap>\n                <h2>{{ \'addon.mod_workshop.yourassessment\' | translate }}</h2>\n            </ion-item>\n            <addon-mod-workshop-assessment [submission]="submission" [assessment]="ownAssessment" [courseId]="courseId" summary="true" [access]="access" [module]="module" [workshop]="workshop"></addon-mod-workshop-assessment>\n        </ion-list>\n\n        <ion-list *ngIf="submissionInfo && submissionInfo.reviewedby && submissionInfo.reviewedby.length && !assessment">\n            <ion-item text-wrap>\n                <h2>{{ \'addon.mod_workshop.receivedgrades\' | translate }}</h2>\n            </ion-item>\n            <ng-container *ngFor="let reviewer of submissionInfo.reviewedby">\n                <addon-mod-workshop-assessment *ngIf="!reviewer.ownAssessment" [submission]="submission" [assessment]="reviewer" [courseId]="courseId" summary="true" [access]="access" [workshop]="workshop"></addon-mod-workshop-assessment>\n            </ng-container>\n        </ion-list>\n\n        <ion-list *ngIf="submissionInfo && submissionInfo.reviewerof && submissionInfo.reviewerof.length && !assessment">\n            <ion-item text-wrap>\n                <h2>{{ \'addon.mod_workshop.givengrades\' | translate }}</h2>\n            </ion-item>\n            <addon-mod-workshop-assessment *ngFor="let reviewer of submissionInfo.reviewerof" [assessment]="reviewer" [courseId]="courseId" summary="true" [workshop]="workshop" [access]="access"></addon-mod-workshop-assessment>\n        </ion-list>\n\n        <form ion-list [formGroup]="feedbackForm" *ngIf="canAddFeedback">\n            <ion-item text-wrap>\n                <h2>{{ \'addon.mod_workshop.feedbackauthor\' | translate }}</h2>\n            </ion-item>\n            <ion-item text-wrap *ngIf="access.canpublishsubmissions">\n                <ion-label>{{ \'addon.mod_workshop.publishsubmission\' | translate }}</ion-label>\n                <ion-toggle formControlName="published"></ion-toggle>\n                <p class="item-help">{{ \'addon.mod_workshop.publishsubmission_help\' | translate }}</p>\n            </ion-item>\n\n            <ion-item text-wrap>\n                <h2>{{ \'addon.mod_workshop.gradecalculated\' | translate }}</h2>\n                <p>{{ submission.submissiongrade }}</p>\n            </ion-item>\n            <ion-item text-wrap>\n                <ion-label stacked>{{ \'addon.mod_workshop.gradeover\' | translate }}</ion-label>\n                <ion-select formControlName="grade" interface="popover">\n                    <ion-option *ngFor="let grade of evaluationGrades" [value]="grade.value">{{grade.label}}</ion-option>\n                </ion-select>\n            </ion-item>\n            <ion-item>\n                <ion-label stacked>{{ \'addon.mod_workshop.feedbackauthor\' | translate }}</ion-label>\n                <core-rich-text-editor item-content [control]="feedbackForm.controls[\'text\']" formControlName="text"></core-rich-text-editor>\n            </ion-item>\n        </form>\n\n        <addon-mod-workshop-assessment-strategy *ngIf="assessmentId" [workshop]="workshop" [access]="access" [assessmentId]="assessmentId" [userId]="assessmentUserId" [strategy]="strategy" [edit]="access.assessingallowed"></addon-mod-workshop-assessment-strategy>\n\n        <ion-list *ngIf="assessmentId && !access.assessingallowed && assessment.feedbackreviewer">\n            <ion-item text-wrap>\n                <ion-avatar item-start *ngIf="evaluateGradingByProfile">\n                    <img [src]="evaluateGradingByProfile.profileimageurl" core-external-content core-user-link [courseId]="courseId" [userId]="evaluateGradingByProfile.id" [alt]="\'core.pictureof\' | translate:{$a: evaluateGradingByProfile.fullname}" role="presentation" onError="this.src=\'assets/img/user-avatar.png\'">\n                </ion-avatar>\n                <h2 *ngIf="evaluateGradingByProfile && evaluateGradingByProfile.fullname">{{ \'addon.mod_workshop.feedbackby\' | translate : {$a: evaluateGradingByProfile.fullname} }}</h2>\n                <core-format-text [text]="assessment.feedbackreviewer"></core-format-text>\n            </ion-item>\n        </ion-list>\n    </core-loading>\n</ion-content>\n'}),y(13,Object(o.N)()),k("design:paramtypes",[n.r,d.a,b.a,g.a,l.a,v.a,n.q,c.a,u.a,i.a,r.c,a.a,h.a,n.f,f.a,m.a])],s)}()}).call(s,t(1982)(e))},1982:function(e,s){e.exports=function(e){if(!e.webpackPolyfill){var s=Object.create(e);s.children||(s.children=[]),Object.defineProperty(s,"loaded",{enumerable:!0,get:function(){return s.l}}),Object.defineProperty(s,"id",{enumerable:!0,get:function(){return s.i}}),Object.defineProperty(s,"exports",{enumerable:!0}),s.webpackPolyfill=1}return s}}});