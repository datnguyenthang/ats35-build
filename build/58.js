webpackJsonp([58],{1851:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),s.d(t,"AddonModWorkshopAssessmentPageModule",function(){return c});var a=s(0),r=s(4),o=s(1),n=s(16),i=s(15),d=s(394),l=s(1977),h=this&&this.__decorate||function(e,t,s,a){var r,o=arguments.length,n=o<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,s,a);else for(var i=e.length-1;i>=0;i--)(r=e[i])&&(n=(o<3?r(n):o>3?r(t,s,n):r(t,s))||n);return o>3&&n&&Object.defineProperty(t,s,n),n},c=function(){function e(){}return e=h([Object(a.I)({declarations:[l.a],imports:[i.a,n.a,d.a,r.l.forChild(l.a),o.b.forChild()]})],e)}()},1977:function(e,t,s){"use strict";s.d(t,"a",function(){return y});var a=s(0),r=s(4),o=s(20),n=s(1),i=s(12),d=s(2),l=s(45),h=s(8),c=s(11),u=s(10),g=s(26),f=s(115),p=s(106),v=s(136),m=s(116),w=s(253),k=this&&this.__decorate||function(e,t,s,a){var r,o=arguments.length,n=o<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,s,a);else for(var i=e.length-1;i>=0;i--)(r=e[i])&&(n=(o<3?r(n):o>3?r(t,s,n):r(t,s))||n);return o>3&&n&&Object.defineProperty(t,s,n),n},I=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},y=function(){function e(e,t,s,a,r,n,i,d,l,h,c,u,g,f,p){var v=this;this.courseProvider=s,this.workshopProvider=a,this.workshopOffline=r,this.workshopHelper=n,this.navCtrl=i,this.syncProvider=d,this.textUtils=l,this.fb=h,this.translate=c,this.eventsProvider=u,this.domUtils=g,this.gradesHelper=f,this.userProvider=p,this.evaluating=!1,this.loaded=!1,this.evaluate={text:"",grade:-1,weight:1},this.weights=[],this.originalEvaluation={},this.hasOffline=!1,this.isDestroyed=!1,this.forceLeave=!1,this.assessment=e.get("assessment"),this.submission=e.get("submission")||{},this.profile=e.get("profile"),this.courseId=e.get("courseId"),this.assessmentId=this.assessment.assessmentid||this.assessment.id,this.workshopId=this.submission.workshopid||null,this.siteId=t.getCurrentSiteId(),this.currentUserId=t.getCurrentSiteUserId(),this.showGrade=this.workshopHelper.showGrade,this.evaluateForm=new o.c({}),this.evaluateForm.addControl("weight",this.fb.control("",o.h.required)),this.evaluateForm.addControl("grade",this.fb.control("")),this.evaluateForm.addControl("text",this.fb.control("")),this.syncObserver=this.eventsProvider.on(w.a.AUTO_SYNCED,function(e){v.workshopId===e.workshopId&&(v.loaded=!1,v.refreshAllData())},this.siteId)}return e.prototype.ngOnInit=function(){this.fetchAssessmentData()},e.prototype.ionViewCanLeave=function(){return!(!this.forceLeave&&this.evaluating)||(this.hasEvaluationChanged()?this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit")):Promise.resolve())},e.prototype.fetchAssessmentData=function(){var e=this;return this.workshopProvider.getWorkshopById(this.courseId,this.workshopId).then(function(t){return e.workshop=t,e.title=e.workshop.name,e.strategy=e.workshop.strategy,e.courseProvider.getModuleBasicGradeInfo(t.coursemodule)}).then(function(t){return e.maxGrade=t.grade,e.workshopProvider.getWorkshopAccessInformation(e.workshopId)}).then(function(t){if(e.access=t,e.assessmentId&&(t.canallocate||t.canoverridegrades)?(e.isDestroyed||e.syncProvider.blockOperation(p.a.COMPONENT,e.workshopId),e.evaluating=!0):e.evaluating=!1,e.evaluating||e.workshop.phase==p.a.PHASE_CLOSED)return e.workshopHelper.getReviewerAssessmentById(e.workshopId,e.assessmentId,e.profile.id).then(function(s){var a,r;if(e.assessment=e.workshopHelper.realGradeValue(e.workshop,s),e.evaluate.text=e.assessment.feedbackreviewer||"",e.evaluate.weight=e.assessment.weight,e.evaluating){if(t.canallocate){e.weights=[];for(var o=16;o>=0;o--)e.weights[o]=o}return t.canoverridegrades?(a=e.translate.instant("addon.mod_workshop.notoverridden"),r=e.gradesHelper.makeGradesMenu(e.workshop.gradinggrade,e.workshopId,a,-1).then(function(t){e.evaluationGrades=t})):r=Promise.resolve(),r.then(function(){return e.workshopOffline.getEvaluateAssessment(e.workshopId,e.assessmentId).then(function(s){e.hasOffline=!0,e.evaluate.weight=s.weight,t.canoverridegrades&&(e.evaluate.text=s.feedbacktext||"",e.evaluate.grade=s.gradinggradeover||-1)}).catch(function(){e.hasOffline=!1,t.canoverridegrades&&(e.evaluate.text=e.assessment.feedbackreviewer||"",e.evaluate.grade=e.assessment.gradinggradeover||-1)})}).finally(function(){e.originalEvaluation.weight=e.evaluate.weight,t.canoverridegrades&&(e.originalEvaluation.text=e.evaluate.text,e.originalEvaluation.grade=e.evaluate.grade),e.evaluateForm.controls.weight.setValue(e.evaluate.weight),t.canoverridegrades&&(e.evaluateForm.controls.grade.setValue(e.evaluate.grade),e.evaluateForm.controls.text.setValue(e.evaluate.text))})}if(e.workshop.phase==p.a.PHASE_CLOSED&&e.assessment.gradinggradeoverby)return e.userProvider.getProfile(e.assessment.gradinggradeoverby,e.courseId,!0).then(function(t){e.evaluateByProfile=t})})}).catch(function(t){e.domUtils.showErrorModalDefault(t,"mm.course.errorgetmodule",!0)}).finally(function(){e.loaded=!0})},e.prototype.forceLeavePage=function(){this.forceLeave=!0,this.navCtrl.pop()},e.prototype.hasEvaluationChanged=function(){if(!this.loaded||!this.evaluating)return!1;var e=this.evaluateForm.value;if(this.originalEvaluation.weight!=e.weight)return!0;if(this.access&&this.access.canoverridegrades){if(this.originalEvaluation.text!=e.text)return!0;if(this.originalEvaluation.grade!=e.grade)return!0}return!1},e.prototype.refreshAllData=function(){var e=this,t=[];return t.push(this.workshopProvider.invalidateWorkshopData(this.courseId)),t.push(this.workshopProvider.invalidateWorkshopAccessInformationData(this.workshopId)),t.push(this.workshopProvider.invalidateReviewerAssesmentsData(this.workshopId)),this.assessmentId&&(t.push(this.workshopProvider.invalidateAssessmentFormData(this.workshopId,this.assessmentId)),t.push(this.workshopProvider.invalidateAssessmentData(this.workshopId,this.assessmentId))),Promise.all(t).finally(function(){return e.eventsProvider.trigger(p.a.ASSESSMENT_INVALIDATED,e.siteId),e.fetchAssessmentData()})},e.prototype.refreshAssessment=function(e){this.loaded&&this.refreshAllData().finally(function(){e.complete()})},e.prototype.saveEvaluation=function(){var e=this;this.hasEvaluationChanged()?this.sendEvaluation().then(function(){e.forceLeavePage()}):this.forceLeavePage()},e.prototype.sendEvaluation=function(){var e=this,t=this.domUtils.showModalLoading("core.sending",!0),s=this.evaluateForm.value;return s.grade=s.grade>=0?s.grade:"",s.text=this.textUtils.formatHtmlLines(s.text),this.workshopProvider.evaluateAssessment(this.workshopId,this.assessmentId,this.courseId,s.text,s.weight,s.grade).then(function(){var t={workshopId:e.workshopId,assessmentId:e.assessmentId,userId:e.currentUserId};return e.workshopProvider.invalidateAssessmentData(e.workshopId,e.assessmentId).finally(function(){e.eventsProvider.trigger(p.a.ASSESSMENT_SAVED,t,e.siteId)})}).catch(function(t){e.domUtils.showErrorModalDefault(t,"Cannot save assessment evaluation")}).finally(function(){t.dismiss()})},e.prototype.ngOnDestroy=function(){this.isDestroyed=!0,this.syncObserver&&this.syncObserver.off(),this.syncProvider.unblockOperation(p.a.COMPONENT,this.workshopId)},e=k([Object(a.m)({selector:"page-addon-mod-workshop-assessment-page",template:'<ion-header>\n    <ion-navbar>\n        <ion-title><core-format-text [text]="title"></core-format-text></ion-title>\n        <ion-buttons end [hidden]="!evaluating">\n            <button ion-button clear (click)="saveEvaluation()" [attr.aria-label]="\'core.save\' | translate">\n                {{ \'core.save\' | translate }}\n            </button>\n        </ion-buttons>\n    </ion-navbar>\n</ion-header>\n<ion-content>\n    <ion-refresher [enabled]="loaded" (ionRefresh)="refreshAssessment($event)">\n        <ion-refresher-content pullingText="{{ \'core.pulltorefresh\' | translate }}"></ion-refresher-content>\n    </ion-refresher>\n    <core-loading [hideUntil]="loaded">\n\n        <ion-item text-wrap>\n            <ion-avatar item-start *ngIf="profile">\n                <img [src]="profile.profileimageurl" core-external-content core-user-link [courseId]="courseId" [userId]="profile.id" [alt]="\'core.pictureof\' | translate:{$a: profile.fullname}" role="presentation" onError="this.src=\'assets/img/user-avatar.png\'">\n            </ion-avatar>\n            <h2 *ngIf="profile && profile.fullname">{{profile.fullname}}</h2>\n\n            <p *ngIf="workshop && assessment && showGrade(assessment.grade)">\n                {{ \'addon.mod_workshop.submissiongradeof\' | translate:{$a: workshop.grade } }}: {{assessment.grade}}\n            </p>\n            <p *ngIf="access && access.canviewallsubmissions && assessment && showGrade(assessment.gradinggrade)" [class.core-has-overriden-grade]=" showGrade(assessment.gradinggrade)">\n                {{ \'addon.mod_workshop.gradinggradeof\' | translate:{$a: workshop.gradinggrade } }}: {{assessment.gradinggrade}}\n            </p>\n            <p *ngIf="access && access.canviewallsubmissions && assessment && showGrade(assessment.gradinggradeover)" class="core-overriden-grade">\n                {{ \'addon.mod_workshop.gradinggradeover\' | translate }}: {{assessment.gradinggradeover}}\n            </p>\n            <p *ngIf="assessment && assessment.weight && assessment.weight != 1">\n                {{ \'addon.mod_workshop.weightinfo\' | translate:{$a: assessment.weight } }}\n            </p>\n            <ion-badge *ngIf="!assessment || !showGrade(assessment.grade)" color="danger">\n                {{ \'addon.mod_workshop.notassessed\' | translate }}\n            </ion-badge>\n        </ion-item>\n\n        <addon-mod-workshop-assessment-strategy *ngIf="assessment && assessmentId && showGrade(assessment.grade) && workshop && access && profile" [workshop]="workshop" [access]="access" [assessmentId]="assessmentId" [userId]="profile.id" [strategy]="strategy"></addon-mod-workshop-assessment-strategy>\n\n        <form ion-list [formGroup]="evaluateForm" *ngIf="evaluating">\n            <ion-item text-wrap>\n                <h2>{{ \'addon.mod_workshop.assessmentsettings\' | translate }}</h2>\n            </ion-item>\n            <ion-item text-wrap *ngIf="access.canallocate">\n                <ion-label stacked core-mark-required="true">{{ \'addon.mod_workshop.assessmentweight\' | translate }}</ion-label>\n                <ion-select formControlName="weight" required="true" interface="popover">\n                    <ion-option *ngFor="let w of weights" [value]="w">{{ w }}</ion-option>\n                </ion-select>\n            </ion-item>\n            <ion-item text-wrap>\n                <h2>{{ \'addon.mod_workshop.gradinggradecalculated\' | translate }}</h2>\n                <p>{{ assessment.gradinggrade }}</p>\n            </ion-item>\n            <ion-item text-wrap *ngIf="access.canoverridegrades">\n                <ion-label stacked>{{ \'addon.mod_workshop.gradinggradeover\' | translate }}</ion-label>\n                <ion-select formControlName="grade" interface="popover">\n                    <ion-option *ngFor="let grade of evaluationGrades" [value]="grade.value">{{grade.label}}</ion-option>\n                </ion-select>\n            </ion-item>\n            <ion-item *ngIf="access.canoverridegrades">\n                <ion-label stacked>{{ \'addon.mod_workshop.feedbackreviewer\' | translate }}</ion-label>\n                <core-rich-text-editor item-content [control]="evaluateForm.controls[\'text\']" formControlName="text"></core-rich-text-editor>\n            </ion-item>\n        </form>\n        <ion-list *ngIf="!evaluating && evaluate && evaluate.text">\n            <ion-item text-wrap>\n                <ion-avatar item-start *ngIf="evaluateGradingByProfile">\n                    <img [src]="evaluateGradingByProfile.profileimageurl" core-external-content core-user-link [courseId]="courseId" [userId]="evaluateGradingByProfile.id" [alt]="\'core.pictureof\' | translate:{$a: evaluateGradingByProfile.fullname}" role="presentation" onError="this.src=\'assets/img/user-avatar.png\'">\n                </ion-avatar>\n                <h2 *ngIf="evaluateGradingByProfile && evaluateGradingByProfile.fullname">{{ \'addon.mod_workshop.feedbackby\' | translate : {$a: evaluateGradingByProfile.fullname} }}</h2>\n                <core-format-text [text]="evaluate.text"></core-format-text>\n            </ion-item>\n        </ion-list>\n    </core-loading>\n</ion-content>\n'}),I("design:paramtypes",[r.r,d.a,u.a,p.a,m.a,v.a,r.q,l.a,c.a,o.a,n.c,i.a,h.a,f.a,g.a])],e)}()}});